<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertas Batu Gunting - Gaming Theme</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(26, 32, 51, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 150, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 0 0 5px rgba(0, 150, 255, 0.7);
            letter-spacing: 1px;
        }
        
        .subtitle {
            text-align: center;
            color: #a0a0ff;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(40, 45, 70, 0.7);
            border-radius: 10px;
            display: none;
            border: 1px solid rgba(0, 150, 255, 0.3);
        }
        
        .active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #a0a0ff;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            background: rgba(20, 25, 45, 0.8);
            color: #fff;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #0096ff;
            box-shadow: 0 0 5px rgba(0, 150, 255, 0.5);
            outline: none;
        }
        
        input[type="number"] {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 5px 0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0096ff, #004aad);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 150, 255, 0.4);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0080e0, #003d8f);
            box-shadow: 0 6px 15px rgba(0, 150, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #00c853, #009624);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 200, 83, 0.4);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #00b347, #007a1f);
            box-shadow: 0 6px 15px rgba(0, 200, 83, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #e65100);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e68900, #cc4700);
            box-shadow: 0 6px 15px rgba(255, 152, 0, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff5252, #c50e29);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 82, 82, 0.4);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e04848, #b00d25);
            box-shadow: 0 6px 15px rgba(255, 82, 82, 0.6);
            transform: translateY(-2px);
        }
        
        .room-info {
            background: rgba(30, 60, 50, 0.6);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(0, 255, 150, 0.3);
        }
        
        .player-list {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            gap: 10px;
        }
        
        .player {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: rgba(20, 25, 45, 0.8);
            border-radius: 8px;
            border: 2px dashed rgba(0, 150, 255, 0.3);
            transition: all 0.3s;
        }
        
        .player.ready {
            border: 2px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .player.choosed {
            border: 2px solid #0096ff;
            background: rgba(0, 150, 255, 0.1);
        }
        
        .player.confirmed {
            border: 2px solid #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }
        
        .player h4 {
            color: #a0a0ff;
            margin-bottom: 5px;
        }
        
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .pilihan-section {
            display: none;
        }
        
        .pilihan-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .btn-pilihan {
            flex: 1;
            padding: 15px;
            background: rgba(40, 45, 70, 0.8);
            color: white;
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .btn-pilihan:hover {
            background: rgba(60, 65, 90, 0.8);
            border-color: #0096ff;
            transform: translateY(-3px);
        }
        
        .btn-pilihan.selected {
            background: rgba(0, 150, 255, 0.2);
            border: 3px solid #0096ff;
        }
        
        .confirmation-section {
            display: none;
            text-align: center;
            padding: 15px;
            background: rgba(0, 50, 100, 0.5);
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(0, 150, 255, 0.3);
        }
        
        .hasil-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            background: rgba(40, 45, 70, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .menang { 
            color: #00ff88; 
            font-weight: bold; 
        }
        
        .kalah { 
            color: #ff5252; 
            font-weight: bold; 
        }
        
        .seri { 
            color: #ffaa00; 
            font-weight: bold; 
        }
        
        .admin-fee {
            background: rgba(255, 200, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }
        
        .room-code {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 3px;
            background: linear-gradient(135deg, #0096ff, #004aad);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 150, 255, 0.4);
        }

        .copy-btn {
            background: rgba(0, 150, 255, 0.8);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: rgba(0, 130, 230, 1);
            transform: translateY(-2px);
        }

        .error-message {
            background: rgba(255, 82, 82, 0.2);
            color: #ff8fa3;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
            border: 1px solid rgba(255, 82, 82, 0.5);
        }

        .success-message {
            background: rgba(0, 255, 136, 0.2);
            color: #88ffc6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .choice-preview {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 200, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .room-stats {
            background: rgba(40, 45, 70, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid rgba(0, 150, 255, 0.2);
        }

        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: #0096ff;
            margin: 10px 0;
        }

        .stats-label {
            font-size: 14px;
            color: #a0a0ff;
        }

        .join-info {
            background: rgba(255, 200, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #ffcc00;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .chat-section {
            margin: 15px 0;
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(20, 25, 45, 0.8);
        }

        .chat-header {
            background: linear-gradient(135deg, #0096ff, #004aad);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(15, 20, 35, 0.8);
            border-bottom: 1px solid rgba(0, 150, 255, 0.2);
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
        }

        .chat-message.system {
            background: rgba(255, 200, 0, 0.1);
            text-align: center;
            font-style: italic;
            color: #ffcc00;
            border-left: 3px solid #ffcc00;
        }

        .chat-message.player {
            background: rgba(0, 150, 255, 0.1);
            border-left: 3px solid #0096ff;
        }

        .chat-message.opponent {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            background: rgba(40, 45, 70, 0.8);
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 5px;
            margin-right: 10px;
            background: rgba(20, 25, 45, 0.8);
            color: white;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #0096ff, #004aad);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: linear-gradient(135deg, #0080e0, #003d8f);
            transform: translateY(-2px);
        }

        .sound-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .sound-btn {
            background: rgba(26, 32, 51, 0.8);
            border: 2px solid rgba(0, 150, 255, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            color: white;
        }

        .sound-btn:hover {
            background: rgba(40, 45, 70, 0.9);
            transform: scale(1.1);
            border-color: #0096ff;
        }

        .sound-btn.muted {
            background: rgba(255, 82, 82, 0.8);
            border-color: rgba(255, 82, 82, 0.7);
        }

        .game-mode-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(40, 45, 70, 0.8);
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .mode-option:hover {
            background: rgba(60, 65, 90, 0.8);
            border-color: #0096ff;
        }

        .mode-option.selected {
            background: rgba(0, 150, 255, 0.2);
            border: 2px solid #0096ff;
        }

        .mode-option h4 {
            color: #a0a0ff;
            margin-bottom: 5px;
        }

        .mode-option .price {
            font-size: 12px;
            color: #00ff88;
        }

        .score-display {
            background: rgba(0, 50, 100, 0.5);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(0, 150, 255, 0.3);
        }

        .score-title {
            font-size: 14px;
            color: #a0a0ff;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 18px;
            font-weight: bold;
            color: #0096ff;
        }

        .round-info {
            background: rgba(255, 200, 0, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            text-align: center;
            font-size: 14px;
            color: #ffcc00;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        /* Victory & Defeat Overlay */
        .victory-overlay, .defeat-overlay, .confirm-overlay, .battle-overlay, .dice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
        }

        .victory-content, .defeat-content, .confirm-content, .battle-content, .dice-content {
            text-align: center;
            padding: 50px;
            border-radius: 20px;
            border: 4px solid;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite, slideIn 0.8s ease;
            max-width: 80%;
        }

        .victory-content {
            background: linear-gradient(135deg, #0096ff, #004aad);
            border-color: #0096ff;
        }

        .defeat-content {
            background: linear-gradient(135deg, #ff5252, #c50e29);
            border-color: #ff5252;
        }

        .confirm-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-color: #0096ff;
        }

        .battle-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-color: #0096ff;
            width: 90%;
            max-width: 500px;
        }

        .dice-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-color: #0096ff;
            width: 90%;
            max-width: 500px;
        }

        .victory-title, .defeat-title, .confirm-title, .battle-title, .dice-title {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: bounce 1s ease infinite;
        }

        .victory-title {
            color: #FFFFFF;
        }

        .defeat-title {
            color: #FFFFFF;
        }

        .confirm-title {
            color: #FFFFFF;
            font-size: 2.5rem;
        }

        .battle-title {
            color: #FFFFFF;
            font-size: 2.5rem;
        }

        .dice-title {
            color: #FFFFFF;
            font-size: 2.5rem;
        }

        .victory-subtitle, .defeat-subtitle, .confirm-subtitle, .battle-subtitle, .dice-subtitle {
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: #FFFFFF;
        }

        .confirm-subtitle, .battle-subtitle, .dice-subtitle {
            font-size: 1.2rem;
        }

        .tap-to-continue {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
            margin-top: 20px;
            animation: blink 2s infinite;
        }

        /* Team-specific styles */
        .team-mode-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .team-option {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            background: rgba(40, 45, 70, 0.8);
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .team-option:hover {
            background: rgba(60, 65, 90, 0.8);
            border-color: #0096ff;
        }

        .team-option.selected {
            background: rgba(0, 150, 255, 0.2);
            border: 2px solid #0096ff;
        }

        .team-option h4 {
            color: #a0a0ff;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .team-display {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            gap: 10px;
        }

        .team {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: rgba(20, 25, 45, 0.8);
            border: 2px solid;
        }

        .team-a {
            border-color: #0096ff;
        }

        .team-b {
            border-color: #00c853;
        }

        .team-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }

        .team-a .team-title {
            background: rgba(0, 150, 255, 0.2);
            color: #0096ff;
        }

        .team-b .team-title {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .team-player {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background: rgba(40, 45, 70, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.2);
        }

        .team-player.ready {
            border: 1px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .team-player.choosed {
            border: 1px solid #0096ff;
            background: rgba(0, 150, 255, 0.1);
        }

        .team-player.confirmed {
            border: 1px solid #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20, 25, 45, 0.8);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 150, 255, 0.5);
            border-radius: 4px;
        }

        .game-controls-container {
            position: relative;
            margin: 20px 0 10px;
            padding: 15px;
            background: rgba(20, 25, 45, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 150, 255, 0.3);
        }

        .leave-button-container {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            margin-top: 10px;
        }

        #sectionGame {
            padding-bottom: 30px;
        }

        .pilihan-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .btn-pilihan {
            flex: 1;
            min-width: 100px;
            padding: 20px 10px;
            background: rgba(40, 45, 70, 0.8);
            color: white;
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        @media (max-width: 480px) {
            .pilihan-buttons {
                flex-direction: column;
            }
            
            .btn-pilihan {
                min-width: auto;
                padding: 15px;
            }
            
            .game-controls-container {
                margin: 15px 0;
                padding: 10px;
            }
        }

        .btn-pilihan:hover {
            background: rgba(60, 65, 90, 0.9);
            border-color: #0096ff;
            transform: translateY(-3px) scale(1.02);
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .confirm-buttons .btn {
            width: auto;
            min-width: 120px;
        }

        .battle-animation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
            height: 200px;
        }

        .battle-choice {
            font-size: 80px;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: rgba(40, 45, 70, 0.8);
            border: 3px solid;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
        }

        .team-a-choice {
            border-color: #0096ff;
            background: rgba(0, 150, 255, 0.2);
        }

        .team-b-choice {
            border-color: #00c853;
            background: rgba(0, 200, 83, 0.2);
        }

        .vs-text {
            font-size: 30px;
            font-weight: bold;
            color: #ffaa00;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 3;
        }

        .battle-result {
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 200, 0, 0.2);
            border: 2px solid rgba(255, 200, 0, 0.5);
        }

        /* Animasi khusus untuk interaksi */
        @keyframes scissorsCut {
            0% { transform: translateX(0) rotate(0deg); }
            50% { transform: translateX(100px) rotate(45deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }

        @keyframes paperWrap {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        @keyframes rockCrush {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes winGlow {
            0% { box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 136, 0.8); }
            100% { box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); }
        }

        @keyframes loseFade {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .scissors-cut {
            animation: scissorsCut 1.5s ease-in-out;
        }

        .paper-wrap {
            animation: paperWrap 1.5s ease-in-out;
        }

        .rock-crush {
            animation: rockCrush 1.5s ease-in-out;
        }

        .win-glow {
            animation: winGlow 2s infinite;
        }

        .lose-fade {
            animation: loseFade 2s infinite;
        }

        /* ==================== STYLE UNTUK DADU ==================== */
        .game-type-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .game-type-option {
            padding: 15px;
            background: rgba(40, 45, 70, 0.8);
            border: 2px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .game-type-option:hover {
            background: rgba(60, 65, 90, 0.8);
            border-color: #0096ff;
        }
        
        .game-type-option.selected {
            background: rgba(0, 150, 255, 0.2);
            border: 2px solid #0096ff;
        }
        
        .game-type-option h4 {
            color: #a0a0ff;
            margin-bottom: 5px;
        }
        
        .game-type-option .description {
            font-size: 14px;
            color: #a0a0ff;
            margin-bottom: 5px;
        }

        .dice-panel {
            margin: 20px 0;
            padding: 15px;
            background: rgba(40, 45, 70, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            text-align: center;
        }
        
        .dice-results {
            margin: 15px 0;
            padding: 10px;
            background: rgba(20, 25, 45, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(0, 150, 255, 0.2);
        }
        
        .dice-result-item {
            margin: 5px 0;
            font-size: 18px;
        }
        
        .dice-total {
            font-weight: bold;
            font-size: 20px;
            color: #0096ff;
            margin-top: 10px;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            perspective: 1000px;
        }
        
        .dice {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 2s ease-out;
        }
        
        .dice-face {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            backface-visibility: hidden;
        }
        
        /* Posisi untuk setiap sisi dadu */
        .dice-face:nth-child(1) { transform: translateZ(40px); } /* Depan */
        .dice-face:nth-child(2) { transform: rotateY(180deg) translateZ(40px); } /* Belakang */
        .dice-face:nth-child(3) { transform: rotateY(-90deg) translateZ(40px); } /* Kiri */
        .dice-face:nth-child(4) { transform: rotateY(90deg) translateZ(40px); } /* Kanan */
        .dice-face:nth-child(5) { transform: rotateX(90deg) translateZ(40px); } /* Atas */
        .dice-face:nth-child(6) { transform: rotateX(-90deg) translateZ(40px); } /* Bawah */
        
        /* Titik-titik pada dadu */
        .dot {
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            position: absolute;
        }
        
        /* Posisi titik untuk setiap angka */
        .face-1 .dot:nth-child(1) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        .face-2 .dot:nth-child(1) { top: 20%; left: 20%; }
        .face-2 .dot:nth-child(2) { bottom: 20%; right: 20%; }
        
        .face-3 .dot:nth-child(1) { top: 20%; left: 20%; }
        .face-3 .dot:nth-child(2) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .face-3 .dot:nth-child(3) { bottom: 20%; right: 20%; }
        
        .face-4 .dot:nth-child(1) { top: 20%; left: 20%; }
        .face-4 .dot:nth-child(2) { top: 20%; right: 20%; }
        .face-4 .dot:nth-child(3) { bottom: 20%; left: 20%; }
        .face-4 .dot:nth-child(4) { bottom: 20%; right: 20%; }
        
        .face-5 .dot:nth-child(1) { top: 20%; left: 20%; }
        .face-5 .dot:nth-child(2) { top: 20%; right: 20%; }
        .face-5 .dot:nth-child(3) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .face-5 .dot:nth-child(4) { bottom: 20%; left: 20%; }
        .face-5 .dot:nth-child(5) { bottom: 20%; right: 20%; }
        
        .face-6 .dot:nth-child(1) { top: 20%; left: 20%; }
        .face-6 .dot:nth-child(2) { top: 20%; right: 20%; }
        .face-6 .dot:nth-child(3) { top: 50%; left: 20%; transform: translateY(-50%); }
        .face-6 .dot:nth-child(4) { top: 50%; right: 20%; transform: translateY(-50%); }
        .face-6 .dot:nth-child(5) { bottom: 20%; left: 20%; }
        .face-6 .dot:nth-child(6) { bottom: 20%; right: 20%; }
        
        /* Animasi dadu */
        @keyframes diceRoll {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            25% { transform: rotateX(360deg) rotateY(180deg) rotateZ(90deg); }
            50% { transform: rotateX(720deg) rotateY(360deg) rotateZ(180deg); }
            75% { transform: rotateX(1080deg) rotateY(540deg) rotateZ(270deg); }
            100% { transform: rotateX(1440deg) rotateY(720deg) rotateZ(360deg); }
        }
        
        .rolling {
            animation: diceRoll 2s ease-out;
        }
    </style>
    
    <!-- SUPABASE SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Victory Overlay -->
    <div class="victory-overlay" id="victoryOverlay" onclick="hideOverlay()">
        <div class="victory-content">
            <div class="victory-title">VICTORY</div>
            <div class="victory-subtitle">You are the Champion! 🏆</div>
            <div class="tap-to-continue">Tap to Continue</div>
        </div>
    </div>

    <!-- Defeat Overlay -->
    <div class="defeat-overlay" id="defeatOverlay" onclick="hideOverlay()">
        <div class="defeat-content">
            <div class="defeat-title">DEFEAT</div>
            <div class="defeat-subtitle">Better luck next time! 💪</div>
            <div class="tap-to-continue">Tap to Continue</div>
        </div>
    </div>

    <!-- Confirmation Overlay -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-content">
            <div class="confirm-title">⚠️ KONFIRMASI</div>
            <div class="confirm-subtitle">ANDA YAKIN INGIN KELUAR DARI ROOM?</div>
            <div class="confirm-buttons">
                <button class="btn btn-danger" onclick="confirmLeave()">YA, KELUAR</button>
                <button class="btn btn-secondary" onclick="cancelLeave()">TIDAK, BATAL</button>
            </div>
        </div>
    </div>

    <!-- Battle Animation Overlay -->
    <div class="battle-overlay" id="battleOverlay">
        <div class="battle-content">
            <div class="battle-title">⚔️ BATTLE ⚔️</div>
            <div class="battle-subtitle" id="battleSubtitle">Team A vs Team B</div>
            
            <div class="battle-animation">
                <div class="battle-choice team-a-choice" id="teamAChoice">
                    <span id="teamAEmoji">❓</span>
                </div>
                <div class="vs-text">VS</div>
                <div class="battle-choice team-b-choice" id="teamBChoice">
                    <span id="teamBEmoji">❓</span>
                </div>
            </div>
            
            <div class="battle-result" id="battleResult">
                Memulai pertarungan...
            </div>
            
            <div class="tap-to-continue" id="battleContinue" style="display: none;" onclick="hideBattleAnimation()">Tap to Continue</div>
        </div>
    </div>

    <!-- Dice Roll Overlay -->
    <div class="dice-overlay" id="diceOverlay">
        <div class="dice-content">
            <div class="dice-title">🎲 LEMPAR DADU 🎲</div>
            <div class="dice-subtitle" id="diceSubtitle">Mempersiapkan dadu...</div>
            
            <div class="dice-container" id="diceAnimationContainer">
                <!-- Dadu akan ditambahkan secara dinamis -->
            </div>
            
            <div class="dice-results" id="diceResults" style="display: none;">
                <div class="dice-result-item" id="diceResultText"></div>
                <div class="dice-total" id="diceTotalText"></div>
            </div>
            
            <div class="tap-to-continue" onclick="hideDiceAnimation()">Tap to Continue</div>
        </div>
    </div>

    <div class="sound-controls">
        <button class="sound-btn" id="soundToggle" onclick="toggleSound()">🔊</button>
    </div>

    <div class="container">
        <h1>🎮 KERTAS BATU GUNTING</h1>
        <div class="subtitle">PEMBUATAN WEB BY CILL</div>
        <style>
.owner-list, .admin-list {
  margin-bottom: 18px;
}
.owner-list ul, .admin-list ul {
  display: flex;
  gap: 13px;
  list-style: none;
  padding: 0;
  overflow-x: auto;
  max-width: 100%;
  margin: 0;
  scrollbar-color: #0096ff #1a1a2e;
}
.owner-list li, .admin-list li {
  background: #111b2e;
  color: #ffaa00;
  padding: 7px 14px;
  border-radius: 8px;
  font-weight: bold;
  white-space: nowrap;
  border: 1px solid #ffaa00;
  box-shadow: 0 2px 6px #0002;
  font-size: 1rem;
}
.admin-list li {
  color: #00ff88;
  border-color: #00ff88;
}
</style>

<div class="owner-list">
  <h3 style="color:#ffaa00">ADMIN</h3>
  <ul>
    <li>CILL</li>
    <li>JOPAN</li>
    <li>RIZZ</li>
    <!-- Tambah owner lain di sini -->
  </ul>
</div>
  <div class="admin-list" style="margin-bottom:20px;">
    <h3 style="color:#00ff88">OWN</h3>
    <ul>
      <li>HUNTER</li>
      <li>DAFFA</li>
    </ul>
  </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- Section 1: Create or Join Room -->
        <div class="section active" id="sectionLobby">
            <div class="input-group">
                <label>Nama Player:</label>
                <input type="text" id="playerName" placeholder="Masukkan nama kamu">
            </div>
            
            <button class="btn btn-primary" onclick="showCreateRoom()">➕ BUAT ROOM</button>
            <button class="btn btn-secondary" onclick="showJoinRoom()">🔗 JOIN ROOM</button>

            <div class="room-stats">
                <h4>📊 STATUS KONEKSI</h4>
                <div class="stats-number" id="connectionStatus">Mengecek...</div>
                <div class="stats-label" id="connectionDetails">Koneksi ke Supabase</div>
                
                <div class="join-info">
                    💡 <strong>Cara Main:</strong><br>
                    1. Buat room baru ATAU join dengan kode room<br>
                    2. Share kode room ke teman untuk bermain
                </div>
            </div>
        </div>
        
        <!-- Section 2: Create Room -->
        <div class="section" id="sectionCreate">
            <h3>Buat Room Baru</h3>
            <div class="input-group">
                <label>Taruhan:</label>
                <input type="text" id="createTaruhan" placeholder="Contoh: 10.000" value="5.000" oninput="formatRupiahInput(this)">
            </div>
            
            <div class="input-group">
                <label>Pilih Mode Permainan:</label>
                <div class="game-type-selector">
                    <div class="game-type-option selected" onclick="selectGameType('kbg')" data-type="kbg">
                        <h4>✂️ KERTAS BATU GUNTING</h4>
                        <p class="description">Game klasik dengan pilihan kertas, batu, atau gunting</p>
                    </div>
                    <div class="game-type-option" onclick="selectGameType('dice1')" data-type="dice1">
                        <h4>🎲 DADU TUNGGAL</h4>
                        <p class="description">Lempar 1 dadu, angka tertinggi menang</p>
                    </div>
                    <div class="game-type-option" onclick="selectGameType('dice3')" data-type="dice3">
                        <h4>🎲🎲🎲 3 DADU</h4>
                        <p class="description">Lempar 3 dadu, total angka tertinggi menang</p>
                    </div>
                </div>
            </div>

            <!-- Opsi tambahan untuk mode Kertas Batu Gunting -->
            <div id="kbgOptions">
                <div class="input-group">
                    <label>Pilih Mode Permainan:</label>
                    <div class="game-mode-selector">
                        <div class="mode-option selected" onclick="selectGameMode('single')">
                            <h4>🎯 SINGLE ROUND</h4>
                            <p>1 Ronde Penentu</p>
                            <p class="price">Taruhan Normal</p>
                        </div>
                        <div class="mode-option" onclick="selectGameMode('bo3')">
                            <h4>⚔️ MPL</h4>
                            <p>3 Ronde Penuh, Total Skor Tertinggi Menang</p>
                            <p class="price">Taruhan Normal</p>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Mode Tim:</label>
                    <div class="team-mode-selector">
                        <div class="team-option selected" onclick="selectTeamMode('1v1')">
                            <h4>👤 1 vs 1</h4>
                            <p>Duel Classic</p>
                        </div>
                        <div class="team-option" onclick="selectTeamMode('2v2')">
                            <h4>👥 2 vs 2</h4>
                            <p>Team Battle</p>
                        </div>
                        <div class="team-option" onclick="selectTeamMode('3v3')">
                            <h4>👥👥 3 vs 3</h4>
                            <p>Squad Match</p>
                        </div>
                        <div class="team-option" onclick="selectTeamMode('4v4')">
                            <h4>👥👥👥 4 vs 4</h4>
                            <p>Full Team</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label>Room Password (optional):</label>
                <input type="text" id="roomPassword" placeholder="Password room (bisa dikosongkan)">
            </div>
            <button class="btn btn-primary" onclick="createRoom()">🎯 BUAT ROOM</button>
            <button class="btn btn-secondary" onclick="backToLobby()">⬅ KEMBALI</button>
        </div>
        
        <!-- Section 3: Join Room -->
        <div class="section" id="sectionJoin">
            <h3>Join Room</h3>
            
            <div class="join-info">
                💡 <strong>Minta kode room</strong> dari teman yang sudah buat room
            </div>
            
            <div class="input-group">
                <label>Kode Room:</label>
                <input type="text" id="joinRoomCode" placeholder="Masukkan kode room dari teman" style="text-transform: uppercase;">
            </div>
            <div class="input-group">
                <label>Password Room (jika ada):</label>
                <input type="text" id="joinPassword" placeholder="Masukkan password room">
            </div>
            
            <!-- TAMBAHAN: Pilihan Team -->
            <div class="input-group" id="teamSelection" style="display: none;">
                <label>Pilih Team:</label>
                <div class="team-selection-buttons" style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="selectJoinTeam('A')" id="teamAButton" style="flex: 1;">👥 TEAM A</button>
                    <button class="btn btn-secondary" onclick="selectJoinTeam('B')" id="teamBButton" style="flex: 1;">👥 TEAM B</button>
                </div>
                <div class="team-info" id="teamInfo" style="margin-top: 10px; padding: 10px; background: rgba(40,45,70,0.7); border-radius: 8px; text-align: center; display: none;">
                    <span id="selectedTeamText"></span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="checkRoom()" id="checkRoomBtn">🔍 CEK ROOM</button>
            <button class="btn btn-primary" onclick="joinRoom()" id="joinRoomBtn" style="display: none;">🎮 JOIN ROOM</button>
            <button class="btn btn-secondary" onclick="backToLobby()">⬅ KEMBALI</button>
        </div>
        
        <!-- Section 4: Game Room -->
        <div class="section" id="sectionGame">
            <div class="room-code" id="displayRoomCode">
                ROOM-XXXX
                <br>
                <button class="copy-btn" onclick="copyRoomCode()">📋 Copy Kode Room</button>
            </div>
            
            <div class="room-info">
                <p>Mode: <strong id="roomMode">Single Round</strong></p>
                <p>Mode Tim: <strong id="roomTeamMode">1v1</strong></p>
                <p>Taruhan: <strong id="roomTaruhan">Rp 0</strong></p>
                <p>Status: <strong id="roomStatus">Menunggu player...</strong></p>
                <p>Pemain: <span id="playerCount">1/2</span></p>
            </div>

            <!-- Score Display -->
            <div class="score-display" id="scoreDisplay" style="display: none;">
                <div class="score-title">SCORE SEMENTARA</div>
                <div class="score-value" id="scoreValue">0 - 0</div>
                <div class="round-info" id="roundInfo">Ronde 1</div>
            </div>
            
            <!-- Chat Room -->
            <div class="chat-section" id="chatSection">
                <div class="chat-header">💬 Chat Room</div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message system">
                        💡 Selamat datang di chat room! Gunakan untuk berkomunikasi dengan lawan.
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." maxlength="100">
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Kirim</button>
                </div>
            </div>
            
            <!-- Player/Team Display -->
            <div id="teamDisplay" style="display: none;">
                <div class="team-display">
                    <div class="team team-a">
                        <div class="team-title">TEAM A</div>
                        <div id="teamAPlayers"></div>
                    </div>
                    <div class="team team-b">
                        <div class="team-title">TEAM B</div>
                        <div id="teamBPlayers"></div>
                    </div>
                </div>
            </div>
            
            <div id="playerDisplay">
                <div class="player-list">
                    <div class="player" id="player1Slot">
                        <h4>Player 1</h4>
                        <div id="player1Name">-</div>
                        <div id="player1Status">Menunggu...</div>
                    </div>
                    <div class="player" id="player2Slot">
                        <h4>Player 2</h4>
                        <div id="player2Name">-</div>
                        <div id="player2Status">Menunggu...</div>
                    </div>
                </div>
            </div>
            
            <!-- Panel untuk permainan dadu -->
            <div class="dice-panel" id="dicePanel" style="display: none;">
                <h3>🎲 Permainan Dadu</h3>
                <p id="diceGameDescription">Lempar dadu dan dapatkan angka tertinggi untuk menang!</p>
                
                <div class="game-controls-container">
                    <div class="game-controls" id="diceControls">
                        <button class="btn btn-primary" onclick="rollDice()" id="rollDiceBtn">🎲 LEMPAR DADU</button>
                    </div>
                </div>
                
                <div class="dice-results" id="diceGameResults" style="display: none;">
                    <h4>Hasil Lemparan:</h4>
                    <div id="diceGameResultText"></div>
                    <div class="dice-total" id="diceGameTotalText"></div>
                </div>
            </div>
            
            <!-- Container untuk game controls -->
            <div class="game-controls-container">
                <div class="game-controls" id="gameControls">
                    <!-- Pilihan Section -->
                    <div class="pilihan-section" id="pilihanSection">
                        <h4>Pilih Salah Satu:</h4>
                        <div class="pilihan-buttons">
                            <button class="btn-pilihan" onclick="selectChoice('kertas')">📄 Kertas</button>
                            <button class="btn-pilihan" onclick="selectChoice('batu')">🪨 Batu</button>
                            <button class="btn-pilihan" onclick="selectChoice('gunting')">✂️ Gunting</button>
                        </div>
                    </div>
                    
                    <!-- Confirmation Section -->
                    <div class="confirmation-section" id="confirmationSection">
                        <div class="choice-preview" id="choicePreview">
                            Anda memilih: <span id="selectedChoice">-</span>
                        </div>
                        <p>Yakin dengan pilihan ini?</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-warning" onclick="confirmChoice()">✅ YA, READY!</button>
                            <button class="btn btn-secondary" onclick="cancelChoice()">❌ BATAL</button>
                        </div>
                    </div>
                </div>
                
                <!-- Container untuk tombol keluar -->
                <div class="leave-button-container">
                    <button class="btn btn-danger" onclick="showConfirmLeave()" id="leaveRoomBtn">🚪 KELUAR ROOM</button>
                </div>
            </div>
            
            <div class="hasil-section" id="hasilSection" style="display: none;">
                <h3>🏆 HASIL PERMAINAN</h3>
                <div id="hasilPertandingan"></div>
                <div id="statusPemenang"></div>
                <div class="admin-fee" id="pembayaranInfo"></div>
                <button class="btn btn-primary" onclick="rematch()">🔄 MAIN LAGI</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://dmxcnbsxgrjjvprkmuar.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRteGNuYnN4Z3JqanZwcmttdWFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzE1NDUsImV4cCI6MjA3NTYwNzU0NX0.LQAfUnB7tMGPvDyNzu2hBYZ7RVl5Glvu_OaIekJ-LeE';
        
        // Inisialisasi Supabase dengan cara yang benar
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==================== GAME DATA ====================
        let gameData = {
            playerName: '',
            roomCode: '',
            isCreator: false,
            playerNumber: 0,
            tempChoice: null,
            soundEnabled: true,
            roomSubscription: null,
            gameType: 'kbg', // kbg, dice1, dice3
            gameMode: 'single', // single, bo3 (hanya untuk kbg)
            teamMode: '1v1', // 1v1, 2v2, 3v3, 4v4 (hanya untuk kbg)
            teamSize: 1
        };

        // Variabel baru untuk pilihan team
        let selectedTeam = null;
        let roomInfo = null;

        // ==================== DICE FUNCTIONS ====================
        function selectGameType(type) {
            gameData.gameType = type;
            
            // Update UI
            document.querySelectorAll('.game-type-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Tampilkan/sembunyikan opsi KBG
            const kbgOptions = document.getElementById('kbgOptions');
            if (type === 'kbg') {
                kbgOptions.style.display = 'block';
            } else {
                kbgOptions.style.display = 'none';
            }
            
            playSound();
        }

        // Fungsi untuk membuat elemen dadu
        function createDiceElement(value) {
    const dice = document.createElement('div');
    dice.className = 'dice';

    // Pola titik [top%, left%] untuk tiap face dadu
    const dotPositions = [
        // 1
        [[50, 50]],
        // 2
        [[25, 25], [75, 75]],
        // 3
        [[25, 25], [50, 50], [75, 75]],
        // 4
        [[25, 25], [25, 75], [75, 25], [75, 75]],
        // 5
        [[25, 25], [25, 75], [75, 25], [75, 75], [50, 50]],
        // 6
        [[25, 25], [25, 50], [25, 75], [75, 25], [75, 50], [75, 75]]
    ];

    for (let i = 0; i < 6; i++) {
        const face = document.createElement('div');
        face.className = `dice-face face-${i + 1}`;
        dotPositions[i].forEach(pos => {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.top = pos[0] + '%';
            dot.style.left = pos[1] + '%';
            dot.style.transform = 'translate(-50%, -50%)';
            face.appendChild(dot);
        });
        dice.appendChild(face);
    }

    setTimeout(() => {
        setDiceValue(dice, value);
    }, 10);

    return dice;
}

        // Fungsi untuk mengatur nilai dadu
        function setDiceValue(dice, value) {
    switch(value) {
        case 1:
            dice.style.transform = 'rotateX(0deg) rotateY(0deg)';
            break;
        case 2:
            dice.style.transform = 'rotateY(180deg)';
            break;
        case 3:
            dice.style.transform = 'rotateY(90deg)';    // DULUNYA -90deg, sekarang 90deg
            break;
        case 4:
            dice.style.transform = 'rotateY(-90deg)';   // DULUNYA 90deg, sekarang -90deg
            break;
        case 5:
            dice.style.transform = 'rotateX(-90deg)';
            break;
        case 6:
            dice.style.transform = 'rotateX(90deg)';
            break;
    }
}

        // Fungsi untuk melempar dadu
        async function rollDice() {
            const room = await getRoom(gameData.roomCode);
            if (!room) {
                showError('Room tidak ditemukan!');
                return;
            }

            const currentPlayer = findCurrentPlayer(room);
            if (!currentPlayer) {
                showError('Player tidak ditemukan!');
                return;
            }

            // Nonaktifkan tombol selama animasi
            document.getElementById('rollDiceBtn').disabled = true;
            
            // Tentukan jumlah dadu berdasarkan gameType
            const diceCount = gameData.gameType === 'dice1' ? 1 : 3;
            const diceValues = [];
            
            // Acak nilai dadu
            for (let i = 0; i < diceCount; i++) {
                diceValues.push(Math.floor(Math.random() * 6) + 1);
            }
            
            // Simpan pilihan dadu
            currentPlayer.pilihan = diceValues.join(',');
            currentPlayer.confirmed = true;
            
            // Tampilkan animasi dadu
            showDiceAnimation(diceValues);
            
            room.chatMessages.push({
                type: 'system',
                message: `🎲 ${gameData.playerName} melempar dadu!`,
                timestamp: new Date().toISOString()
            });

            // Cek apakah semua pemain sudah memilih
            const allPlayers = [...room.teams.teamA, ...room.teams.teamB];
            const allConfirmed = allPlayers.filter(p => p.name).every(p => p.confirmed);
            
            if (allConfirmed) {
                setTimeout(() => calculateDiceResult(room), 3000);
            }
            
            await saveRoom(gameData.roomCode, room);
            playSound();
        }

        // Fungsi untuk menampilkan animasi dadu
        function showDiceAnimation(diceValues) {
            const diceOverlay = document.getElementById('diceOverlay');
            const diceContainer = document.getElementById('diceAnimationContainer');
            const diceSubtitle = document.getElementById('diceSubtitle');
            const diceResults = document.getElementById('diceResults');
            const diceResultText = document.getElementById('diceResultText');
            const diceTotalText = document.getElementById('diceTotalText');
            
            // Reset container
            diceContainer.innerHTML = '';
            diceResults.style.display = 'none';
            
            // Tampilkan overlay
            diceOverlay.style.display = 'flex';
            diceSubtitle.textContent = 'Melempar dadu...';
            
            // Buat elemen dadu
            diceValues.forEach((value, index) => {
                const dice = createDiceElement(1); // Mulai dengan nilai 1
                diceContainer.appendChild(dice);
                
                // Animasi putaran
                dice.classList.add('rolling');
                
                // Setelah animasi selesai, tampilkan nilai sebenarnya
                setTimeout(() => {
                    dice.classList.remove('rolling');
                    setDiceValue(dice, value);
                }, 2000);
            });
            
            // Tampilkan hasil setelah animasi selesai
            setTimeout(() => {
                diceSubtitle.textContent = 'Hasil Lemparan:';
                diceResults.style.display = 'block';
                
                if (diceValues.length === 1) {
                    diceResultText.textContent = `Dadu: ${diceValues[0]}`;
                    diceTotalText.textContent = '';
                } else {
                    const total = diceValues.reduce((sum, val) => sum + val, 0);
                    diceResultText.textContent = `Dadu: ${diceValues.join(' + ')}`;
                    diceTotalText.textContent = `Total: ${total}`;
                }
            }, 2500);
            
            playSound();
        }

        // Fungsi untuk menyembunyikan animasi dadu
        function hideDiceAnimation() {
            document.getElementById('diceOverlay').style.display = 'none';
            playSound();
        }

        // Fungsi untuk menghitung hasil permainan dadu
        async function calculateDiceResult(roomData) {
            let room = roomData;
            if (!room) {
                room = await getRoom(gameData.roomCode);
            }
            
            if (!room) return;
            
            const allPlayers = [...room.teams.teamA, ...room.teams.teamB];
            const playersWithChoices = allPlayers.filter(p => p.name && p.pilihan);
            
            // Hitung nilai untuk setiap pemain
            const playerScores = playersWithChoices.map(player => {
                const diceValues = player.pilihan.split(',').map(val => parseInt(val));
                const total = diceValues.reduce((sum, val) => sum + val, 0);
                return {
                    player: player,
                    values: diceValues,
                    total: total
                };
            });
            
            // Urutkan berdasarkan nilai tertinggi
            playerScores.sort((a, b) => b.total - a.total);
            
            // Tentukan pemenang
            let winners = [];
            let resultMessage = '';
            
            if (playerScores.length > 0) {
                const highestScore = playerScores[0].total;
                winners = playerScores.filter(score => score.total === highestScore);
                
                if (winners.length === 1) {
                    resultMessage = `${winners[0].player.name} MENANG dengan nilai ${highestScore}!`;
                } else {
                    resultMessage = `SERI! ${winners.map(w => w.player.name).join(' dan ')} sama-sama mendapatkan nilai ${highestScore}`;
                }
            }
            
            // Tampilkan hasil di UI
            updateDiceGameResults(playerScores, resultMessage);
            
            // Simpan hasil ke room
            room.hasil = {
                pemenang: winners.length === 1 ? (room.teams.teamA.some(p => p.name === winners[0].player.name) ? 'teamA' : 'teamB') : 'seri',
                hasil: resultMessage,
                playerScores: playerScores,
                gameType: 'dice'
            };
            room.status = 'finished';
            
            room.chatMessages.push({
                type: 'system',
                message: `🏆 ${resultMessage}`,
                timestamp: new Date().toISOString()
            });

            await saveRoom(gameData.roomCode, room);
            playSound();
        }

        // Fungsi untuk memperbarui tampilan hasil permainan dadu
        function updateDiceGameResults(playerScores, resultMessage) {
            const resultsContainer = document.getElementById('diceGameResults');
            const resultText = document.getElementById('diceGameResultText');
            const totalText = document.getElementById('diceGameTotalText');
            
            resultsContainer.style.display = 'block';
            
            let resultsHTML = '';
            playerScores.forEach(score => {
                if (score.values.length === 1) {
                    resultsHTML += `<div class="dice-result-item">${score.player.name}: ${score.values[0]}</div>`;
                } else {
                    resultsHTML += `<div class="dice-result-item">${score.player.name}: ${score.values.join(' + ')} = ${score.total}</div>`;
                }
            });
            
            resultText.innerHTML = resultsHTML;
            totalText.textContent = resultMessage;
            
            // Nonaktifkan tombol lempar dadu
            document.getElementById('rollDiceBtn').disabled = true;
        }

        // ==================== BATTLE ANIMATION FUNCTIONS ====================
        function showBattleAnimation(teamAChoice, teamBChoice) {
            const battleOverlay = document.getElementById('battleOverlay');
            const teamAEmoji = document.getElementById('teamAEmoji');
            const teamBEmoji = document.getElementById('teamBEmoji');
            const battleResult = document.getElementById('battleResult');
            const battleSubtitle = document.getElementById('battleSubtitle');
            const battleContinue = document.getElementById('battleContinue');
            
            // Set emoji untuk pilihan
            teamAEmoji.textContent = getChoiceEmoji(teamAChoice);
            teamBEmoji.textContent = getChoiceEmoji(teamBChoice);
            
            // Reset animasi
            document.getElementById('teamAChoice').className = 'battle-choice team-a-choice';
            document.getElementById('teamBChoice').className = 'battle-choice team-b-choice';
            
            // Tampilkan overlay
            battleOverlay.style.display = 'flex';
            battleResult.textContent = "Memulai pertarungan...";
            battleContinue.style.display = 'none';
            
            // Tentukan hasil pertarungan
            const result = determineWinner(teamAChoice, teamBChoice);
            let resultText = "";
            let winner = null;
            
            if (result === 0) {
                resultText = "SERI! Kedua pilihan sama kuat!";
                winner = 'seri';
            } else if (result === 1) {
                resultText = `TEAM A MENANG! ${getWinText(teamAChoice, teamBChoice)}`;
                winner = 'teamA';
            } else {
                resultText = `TEAM B MENANG! ${getWinText(teamBChoice, teamAChoice)}`;
                winner = 'teamB';
            }
            
            // Update subtitle
            battleSubtitle.textContent = `Team A (${teamAChoice}) vs Team B (${teamBChoice})`;
            
            // Jalankan animasi setelah delay
            setTimeout(() => {
                battleResult.textContent = resultText;
                
                // Terapkan animasi berdasarkan pilihan
                applyBattleAnimation(teamAChoice, teamBChoice, winner);
                
                // Tampilkan tombol continue setelah animasi selesai
                setTimeout(() => {
                    battleContinue.style.display = 'block';
                }, 2000);
                
            }, 1500);
            
            playSound();
        }

        function getChoiceEmoji(choice) {
            switch(choice) {
                case 'kertas': return '📄';
                case 'batu': return '🪨';
                case 'gunting': return '✂️';
                default: return '❓';
            }
        }

        function getWinText(winnerChoice, loserChoice) {
            if (winnerChoice === 'batu' && loserChoice === 'gunting') {
                return "Batu menghancurkan Gunting!";
            } else if (winnerChoice === 'gunting' && loserChoice === 'kertas') {
                return "Gunting memotong Kertas!";
            } else if (winnerChoice === 'kertas' && loserChoice === 'batu') {
                return "Kertas membungkus Batu!";
            }
            return "";
        }

        function applyBattleAnimation(choiceA, choiceB, winner) {
            const teamAElement = document.getElementById('teamAChoice');
            const teamBElement = document.getElementById('teamBChoice');
            
            // Reset classes
            teamAElement.classList.remove('win-glow', 'lose-fade', 'scissors-cut', 'paper-wrap', 'rock-crush');
            teamBElement.classList.remove('win-glow', 'lose-fade', 'scissors-cut', 'paper-wrap', 'rock-crush');
            
            if (winner === 'teamA') {
                teamAElement.classList.add('win-glow');
                teamBElement.classList.add('lose-fade');
                
                // Terapkan animasi spesifik berdasarkan pilihan
                if (choiceA === 'gunting' && choiceB === 'kertas') {
                    teamAElement.classList.add('scissors-cut');
                } else if (choiceA === 'kertas' && choiceB === 'batu') {
                    teamAElement.classList.add('paper-wrap');
                } else if (choiceA === 'batu' && choiceB === 'gunting') {
                    teamAElement.classList.add('rock-crush');
                }
            } else if (winner === 'teamB') {
                teamAElement.classList.add('lose-fade');
                teamBElement.classList.add('win-glow');
                
                // Terapkan animasi spesifik berdasarkan pilihan
                if (choiceB === 'gunting' && choiceA === 'kertas') {
                    teamBElement.classList.add('scissors-cut');
                } else if (choiceB === 'kertas' && choiceA === 'batu') {
                    teamBElement.classList.add('paper-wrap');
                } else if (choiceB === 'batu' && choiceA === 'gunting') {
                    teamBElement.classList.add('rock-crush');
                }
            } else {
                // Seri - kedua tim mendapat efek glow
                teamAElement.classList.add('win-glow');
                teamBElement.classList.add('win-glow');
            }
        }

        function hideBattleAnimation() {
            document.getElementById('battleOverlay').style.display = 'none';
            playSound();
        }

        // ==================== KONFIRMASI KELUAR FUNCTIONS ====================
        function showConfirmLeave() {
            const confirmOverlay = document.getElementById('confirmOverlay');
            confirmOverlay.style.display = 'flex';
            playSound();
        }

        function cancelLeave() {
            const confirmOverlay = document.getElementById('confirmOverlay');
            confirmOverlay.style.display = 'none';
            playSound();
        }

        function confirmLeave() {
            const confirmOverlay = document.getElementById('confirmOverlay');
            confirmOverlay.style.display = 'none';
            leaveRoom();
        }

        // ==================== VICTORY & DEFEAT FUNCTIONS ====================
        function showVictory() {
            if (!gameData.soundEnabled) return;
            
            // Play victory sound
            playVictorySound();
            
            // Show victory overlay
            const victoryOverlay = document.getElementById('victoryOverlay');
            victoryOverlay.style.display = 'flex';
            
            console.log('🎉 VICTORY!');
        }

        function showDefeat() {
            if (!gameData.soundEnabled) return;
            
            // Play defeat sound
            playDefeatSound();
            
            // Show defeat overlay
            const defeatOverlay = document.getElementById('defeatOverlay');
            defeatOverlay.style.display = 'flex';
            
            console.log('💔 DEFEAT!');
        }

        function hideOverlay() {
            document.getElementById('victoryOverlay').style.display = 'none';
            document.getElementById('defeatOverlay').style.display = 'none';
        }

        function playVictorySound() {
            if (!gameData.soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create multiple oscillators for a more complex victory sound
                const oscillators = [];
                const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, C (high)
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    // Stagger the start times for a chord effect
                    const startTime = audioContext.currentTime + (index * 0.1);
                    const endTime = startTime + 0.5;
                    
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, endTime);
                    
                    oscillator.start(startTime);
                    oscillator.stop(endTime);
                    
                    oscillators.push(oscillator);
                });
                
            } catch (e) {
                console.log('Victory sound not supported');
            }
        }

        function playDefeatSound() {
            if (!gameData.soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Falling frequency for defeat sound
                oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G
                oscillator.frequency.exponentialRampToValueAtTime(130.81, audioContext.currentTime + 0.8); // C (low)
                
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
                
            } catch (e) {
                console.log('Defeat sound not supported');
            }
        }

        // ==================== TEAM MODE FUNCTIONS ====================
        function selectTeamMode(mode) {
            gameData.teamMode = mode;
            gameData.teamSize = parseInt(mode[0]); // Extract number from '2v2'
            
            document.querySelectorAll('.team-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            playSound();
        }

        function getTeamSize() {
            switch(gameData.teamMode) {
                case '1v1': return 1;
                case '2v2': return 2;
                case '3v3': return 3;
                case '4v4': return 4;
                default: return 1;
            }
        }

        // ==================== AUTO CLEANUP FUNCTIONS ====================
        async function cleanupOldRooms() {
            try {
                console.log('🔄 Running auto-cleanup...');
                const rooms = await getAllRooms();
                const now = new Date();
                let deletedCount = 0;

                for (const [roomCode, roomData] of Object.entries(rooms)) {
                    // Skip if room doesn't have createdAt
                    if (!roomData.createdAt) continue;
                    
                    const roomAge = now - new Date(roomData.createdAt);
                    const ageInHours = roomAge / (1000 * 60 * 60);
                    
                    // Delete rooms older than 24 hours
                    if (ageInHours > 24) {
                        await deleteRoom(roomCode);
                        deletedCount++;
                        console.log(`🧹 Deleted old room: ${roomCode} (${ageInHours.toFixed(1)} hours old)`);
                    }
                }
                
                if (deletedCount > 0) {
                    console.log(`✅ Cleanup completed: ${deletedCount} rooms deleted`);
                }
            } catch (error) {
                console.error('❌ Cleanup error:', error);
            }
        }

        // Cleanup room setelah game selesai
        async function cleanupFinishedRoom(roomCode) {
            setTimeout(async () => {
                await deleteRoom(roomCode);
                console.log(`🧹 Auto-deleted finished room: ${roomCode}`);
            }, 5 * 60 * 1000); // 5 menit setelah game selesai
        }

        // ==================== SUPABASE FUNCTIONS ====================
        async function getRoom(roomCode) {
            try {
                console.log('Getting room:', roomCode);
                
                const { data, error } = await supabase
                    .from('rooms')
                    .select('*')
                    .eq('code', roomCode)
                    .single();
                    
                if (error) {
                    console.log('Room not found:', roomCode, error);
                    return null;
                }
                
                if (data && data.data) {
                    console.log('Room found:', data.data);
                    // Tambahkan code ke data room untuk konsistensi
                    data.data.code = roomCode;
                    return data.data;
                }
                
                return null;
            } catch (error) {
                console.error('Error getting room:', error);
                return null;
            }
        }

        async function saveRoom(roomCode, roomData) {
            try {
                const { data, error } = await supabase
                    .from('rooms')
                    .upsert({
                        code: roomCode,
                        data: roomData,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'code'
                    });
                    
                if (error) {
                    console.error('Supabase save error:', error);
                    return false;
                }
                console.log('Room saved successfully:', roomCode);
                return true;
            } catch (error) {
                console.error('Error saving room:', error);
                return false;
            }
        }

        async function deleteRoom(roomCode) {
            try {
                const { error } = await supabase
                    .from('rooms')
                    .delete()
                    .eq('code', roomCode);
                    
                return !error;
            } catch (error) {
                console.error('Error deleting room:', error);
                return false;
            }
        }

        async function getAllRooms() {
            try {
                const { data, error } = await supabase
                    .from('rooms')
                    .select('code, data');
                    
                if (error) {
                    console.error('Error getting rooms:', error);
                    return {};
                }
                
                const roomsMap = {};
                if (data) {
                    data.forEach(room => {
                        roomsMap[room.code] = room.data;
                    });
                }
                return roomsMap;
            } catch (error) {
                console.error('Error getting all rooms:', error);
                return {};
            }
        }

        function startRoomListener(roomCode, callback) {
            console.log('Starting realtime listener for:', roomCode);
            
            // Unsubscribe existing listener if any
            if (gameData.roomSubscription) {
                gameData.roomSubscription.unsubscribe();
            }

            const subscription = supabase
                .channel('room-changes')
                .on('postgres_changes', 
                    {
                        event: '*',
                        schema: 'public',
                        table: 'rooms',
                        filter: `code=eq.${roomCode}`
                    },
                    (payload) => {
                        console.log('Realtime update:', payload);
                        if (payload.new && payload.new.data) {
                            callback(payload.new.data);
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });

            gameData.roomSubscription = subscription;
            return subscription;
        }

        function stopRoomListener() {
            if (gameData.roomSubscription) {
                gameData.roomSubscription.unsubscribe();
                gameData.roomSubscription = null;
                console.log('Room listener stopped');
            }
        }

        // ==================== GAME FUNCTIONS ====================
        function selectGameMode(mode) {
            gameData.gameMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            playSound();
        }

        function calculateAdminFee(taruhan) {
            if (taruhan >= 1 && taruhan <= 9500) return 1000;
            if (taruhan >= 10000 && taruhan <= 19900) return 2000;
            if (taruhan >= 20000 && taruhan <= 29900) return 3000;
            if (taruhan >= 30000 && taruhan <= 39900) return 4000;
            if (taruhan >= 40000 && taruhan <= 49900) return 5000;
            if (taruhan >= 50000 && taruhan <= 59900) return 6000;
            if (taruhan >= 60000 && taruhan <= 69900) return 7000;
            if (taruhan >= 70000 && taruhan <= 79900) return 8000;
            if (taruhan >= 80000 && taruhan <= 89900) return 9000;
            if (taruhan >= 90000 && taruhan <= 99900) return 10000;
            if (taruhan >= 100000) return Math.floor(taruhan / 10000) * 1000;
            return 1000;
        }

        function playSound() {
            if (!gameData.soundEnabled) return;
            // Simple sound implementation
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.log('Sound not supported');
            }
        }

        function toggleSound() {
            gameData.soundEnabled = !gameData.soundEnabled;
            const soundBtn = document.getElementById('soundToggle');
            soundBtn.textContent = gameData.soundEnabled ? '🔊' : '🔇';
            soundBtn.classList.toggle('muted', !gameData.soundEnabled);
            showSuccess(gameData.soundEnabled ? 'Sound diaktifkan' : 'Sound dimatikan');
            playSound();
        }

        function formatRupiahInput(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('id-ID');
                input.value = value;
            }
        }

        function parseRupiahInput(inputValue) {
            return parseInt(inputValue.replace(/[^\d]/g, '') || 0);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
            playSound();
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function showCreateRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('Masukkan nama dulu!');
                document.getElementById('playerName').focus();
                return;
            }
            gameData.playerName = playerName;
            showSection('sectionCreate');
            playSound();
        }

        function showJoinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('Masukkan nama dulu!');
                document.getElementById('playerName').focus();
                return;
            }
            gameData.playerName = playerName;
            updateRoomStats();
            showSection('sectionJoin');
            playSound();
        }

        function backToLobby() {
            // Reset state pilihan team
            roomInfo = null;
            selectedTeam = null;
            
            // Reset UI
            document.getElementById('teamSelection').style.display = 'none';
            document.getElementById('checkRoomBtn').style.display = 'block';
            document.getElementById('joinRoomBtn').style.display = 'none';
            document.getElementById('teamInfo').style.display = 'none';
            
            showSection('sectionLobby');
            updateRoomStats();
            playSound();
        }

        async function updateRoomStats() {
            try {
                const rooms = await getAllRooms();
                const activeRooms = Object.entries(rooms).filter(([code, room]) => {
                    return room && room.status === 'waiting';
                });
                
                document.getElementById('connectionStatus').textContent = `${activeRooms.length} Room Aktif`;
            } catch (error) {
                console.error('Error updating room stats:', error);
            }
        }

        // Fungsi untuk mengecek room sebelum join
        async function checkRoom() {
            const roomCodeInput = document.getElementById('joinRoomCode');
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            
            if (!roomCode) {
                showError('Masukkan kode room!');
                roomCodeInput.focus();
                return;
            }

            if (roomCode.length !== 4) {
                showError('Kode room harus 4 karakter!');
                roomCodeInput.focus();
                return;
            }

            console.log('Checking room:', roomCode);
            
            const room = await getRoom(roomCode);
            if (!room) {
                showError('Room ' + roomCode + ' tidak ditemukan! Pastikan kode room benar.');
                return;
            }

            // Simpan info room untuk digunakan nanti
            roomInfo = room;
            
            // Tampilkan pilihan team
            document.getElementById('teamSelection').style.display = 'block';
            document.getElementById('checkRoomBtn').style.display = 'none';
            document.getElementById('joinRoomBtn').style.display = 'block';
            
            // Reset pilihan team
            selectedTeam = null;
            document.getElementById('teamInfo').style.display = 'none';
            
            // Update info slot team
            updateTeamSlotInfo(room);
            
            showSuccess('Room ditemukan! Silakan pilih team.');
            playSound();
        }

        // Fungsi untuk memilih team saat join
        function selectJoinTeam(team) {
            if (!roomInfo) {
                showError('Silakan cek room terlebih dahulu!');
                return;
            }
            
            selectedTeam = team;
            
            // Update UI
            document.querySelectorAll('.team-selection-buttons .btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-secondary');
                btn.classList.add('btn-secondary');
            });
            
            if (team === 'A') {
                document.getElementById('teamAButton').classList.remove('btn-secondary');
                document.getElementById('teamAButton').classList.add('btn-primary');
            } else {
                document.getElementById('teamBButton').classList.remove('btn-secondary');
                document.getElementById('teamBButton').classList.add('btn-primary');
            }
            
            // Tampilkan info team yang dipilih
            const teamInfoDiv = document.getElementById('teamInfo');
            teamInfoDiv.style.display = 'block';
            document.getElementById('selectedTeamText').textContent = `Anda memilih: TEAM ${team}`;
            
            playSound();
        }

        // Fungsi untuk update info slot team
        function updateTeamSlotInfo(room) {
            const teamSize = room.teamSize || 1;
            const teamACount = room.teams.teamA.filter(p => p.name).length;
            const teamBCount = room.teams.teamB.filter(p => p.name).length;
            
            document.getElementById('teamAButton').innerHTML = `👥 TEAM A (${teamACount}/${teamSize})`;
            document.getElementById('teamBButton').innerHTML = `👥 TEAM B (${teamBCount}/${teamSize})`;
            
            // Nonaktifkan tombol jika team sudah penuh
            document.getElementById('teamAButton').disabled = (teamACount >= teamSize);
            document.getElementById('teamBButton').disabled = (teamBCount >= teamSize);
            
            if (teamACount >= teamSize && teamBCount >= teamSize) {
                showError('Kedua team sudah penuh! Tidak bisa join room ini.');
                document.getElementById('joinRoomBtn').disabled = true;
            } else {
                document.getElementById('joinRoomBtn').disabled = false;
            }
        }

        // CREATE ROOM dengan Supabase
        async function createRoom() {
            const taruhanInput = document.getElementById('createTaruhan').value;
            const password = document.getElementById('roomPassword').value;
            
            const taruhan = parseRupiahInput(taruhanInput);
            if (!taruhan || taruhan <= 0) {
                showError('Masukkan jumlah taruhan yang valid!');
                return;
            }

            if (taruhan < 1000) {
                showError('Taruhan minimal Rp 1.000!');
                return;
            }

            const teamSize = gameData.gameType === 'kbg' ? getTeamSize() : 1;
            const totalPlayers = gameData.gameType === 'kbg' ? teamSize * 2 : 2;

            let roomCode;
            let attempts = 0;
            let rooms = await getAllRooms();
            
            do {
                roomCode = generateRoomCode();
                attempts++;
            } while (rooms[roomCode] && attempts < 10);

            if (attempts >= 10) {
                showError('Gagal membuat room, coba lagi!');
                return;
            }

            gameData.roomCode = roomCode;
            gameData.isCreator = true;
            gameData.playerNumber = 1;

            // Inisialisasi struktur data room
            const roomData = {
                password: password,
                taruhan: taruhan,
                gameType: gameData.gameType,
                gameMode: gameData.gameMode,
                teamMode: gameData.teamMode,
                teamSize: teamSize,
                teams: {
                    teamA: [
                        { 
                            name: gameData.playerName, 
                            pilihan: null, 
                            confirmed: false,
                            playerNumber: 1
                        }
                    ],
                    teamB: []
                },
                status: 'waiting',
                hasil: null,
                scores: { teamA: 0, teamB: 0 },
                currentRound: 1,
                roundHistory: [],
                createdAt: new Date().toISOString(),
                showChoices: false,
                showResult: false,
                chatMessages: [{
                    type: 'system',
                    message: `🎮 ${gameData.playerName} membuat room ${gameData.gameType === 'kbg' ? gameData.teamMode : 'Dadu'}!`,
                    timestamp: new Date().toISOString()
                }]
            };

            // Tambahkan slot kosong untuk pemain lainnya
            if (gameData.gameType === 'kbg') {
                // Mode Kertas Batu Gunting dengan tim
                for (let i = 2; i <= teamSize; i++) {
                    roomData.teams.teamA.push({
                        name: null,
                        pilihan: null,
                        confirmed: false,
                        playerNumber: i
                    });
                }

                for (let i = 1; i <= teamSize; i++) {
                    roomData.teams.teamB.push({
                        name: null,
                        pilihan: null,
                        confirmed: false,
                        playerNumber: i + teamSize
                    });
                }
            } else {
                // Mode Dadu - hanya 1v1
                roomData.teams.teamB.push({
                    name: null,
                    pilihan: null,
                    confirmed: false,
                    playerNumber: 2
                });
            }

            console.log('Creating room:', roomCode, roomData);
            
            const success = await saveRoom(roomCode, roomData);
            if (success) {
                showSuccess(`Room ${roomCode} (${gameData.gameType}) berhasil dibuat! 🎉`);
                enterGameRoom();
                playSound();
            } else {
                showError('Gagal membuat room! Coba lagi.');
            }
        }

        function getModeDisplayName(mode) {
            switch(mode) {
                case 'single': return 'Single Round';
                case 'bo3': return 'MPL (3 Ronde)';
                default: return 'Single Round';
            }
        }

        // JOIN ROOM dengan pilihan team
        async function joinRoom() {
            if (!selectedTeam) {
                showError('Pilih team dulu!');
                return;
            }

            const roomCodeInput = document.getElementById('joinRoomCode').value.toUpperCase().trim();
            const password = document.getElementById('joinPassword').value;
            
            if (!roomCodeInput) {
                showError('Masukkan kode room!');
                return;
            }

            console.log('Joining room:', roomCodeInput, 'Team:', selectedTeam);

            // Ambil data room terbaru
            const room = await getRoom(roomCodeInput);
            if (!room) {
                showError('Room tidak ditemukan! Pastikan kode room benar.');
                return;
            }

            // Cek password
            if (room.password && room.password !== password) {
                showError('Password room salah!');
                return;
            }

            // Cari slot kosong di team yang dipilih
            const targetTeam = selectedTeam === 'A' ? room.teams.teamA : room.teams.teamB;
            let emptySlot = null;
            let playerNumber = null;
            
            for (let player of targetTeam) {
                if (!player.name) {
                    emptySlot = player;
                    playerNumber = player.playerNumber;
                    break;
                }
            }

            if (!emptySlot) {
                showError(`Team ${selectedTeam} sudah penuh! Pilih team lain.`);
                return;
            }

            // Set game data
            gameData.roomCode = roomCodeInput;
            gameData.isCreator = false;
            gameData.playerNumber = playerNumber;
            gameData.gameMode = room.gameMode || 'single';
            gameData.teamMode = room.teamMode || '1v1';
            gameData.selectedTeam = selectedTeam;

            // Isi slot kosong
            emptySlot.name = gameData.playerName;
            emptySlot.pilihan = null;
            emptySlot.confirmed = false;
            
            // Update status room
            const totalPlayers = room.teams.teamA.filter(p => p.name).length + 
                                room.teams.teamB.filter(p => p.name).length;
            const requiredPlayers = room.gameType === 'kbg' ? (room.teamSize || 1) * 2 : 2;
            
            room.status = totalPlayers >= requiredPlayers ? 'ready' : 'waiting';
            
            // Tambah chat message
            if (!room.chatMessages) room.chatMessages = [];
            room.chatMessages.push({
                type: 'system',
                message: `🎮 ${gameData.playerName} bergabung ke Team ${selectedTeam}!`,
                timestamp: new Date().toISOString()
            });

            // Simpan ke database
            const success = await saveRoom(gameData.roomCode, room);
            if (success) {
                showSuccess(`Berhasil join room ${gameData.roomCode} di Team ${selectedTeam}! 🎮`);
                enterGameRoom();
                playSound();
                
                // Reset form
                document.getElementById('joinRoomCode').value = '';
                document.getElementById('joinPassword').value = '';
            } else {
                showError('Gagal join room! Coba lagi.');
            }
            
            // Reset state
            roomInfo = null;
            selectedTeam = null;
        }

        function copyRoomCode() {
            const roomCode = gameData.roomCode;
            navigator.clipboard.writeText(roomCode).then(function() {
                showSuccess('Kode room disalin: ' + roomCode);
            }).catch(function(err) {
                // Fallback untuk browser lama
                const tempInput = document.createElement('input');
                tempInput.value = roomCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showSuccess('Kode room disalin: ' + roomCode);
            });
            playSound();
        }

        function enterGameRoom() {
            showSection('sectionGame');
            resetChoiceUI();
            startRoomListener(gameData.roomCode, updateRoomDisplay);
            
            // Setup chat input
            const chatInput = document.getElementById('chatInput');
            chatInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            };
            
            // Load initial room state
            loadRoomState();
        }

        async function loadRoomState() {
            const room = await getRoom(gameData.roomCode);
            if (room) {
                updateRoomDisplay(room);
            }
        }

        function resetChoiceUI() {
            document.getElementById('pilihanSection').style.display = 'block';
            document.getElementById('confirmationSection').style.display = 'none';
            gameData.tempChoice = null;
            
            document.querySelectorAll('.btn-pilihan').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            const room = await getRoom(gameData.roomCode);
            if (!room) return;
            
            room.chatMessages.push({
                type: 'player',
                player: gameData.playerName,
                message: message,
                timestamp: new Date().toISOString()
            });
            
            await saveRoom(gameData.roomCode, room);
            chatInput.value = '';
            playSound();
        }

        function updateChatDisplay(room) {
            if (!room || !room.chatMessages) return;
            
            const chatMessagesDiv = document.getElementById('chatMessages');
            chatMessagesDiv.innerHTML = '';
            
            room.chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.type}`;
                
                if (msg.type === 'system') {
                    messageDiv.innerHTML = `💬 ${msg.message}`;
                } else {
                    const isOwnMessage = msg.player === gameData.playerName;
                    messageDiv.className = `chat-message ${isOwnMessage ? 'player' : 'opponent'}`;
                    messageDiv.innerHTML = `<strong>${msg.player}:</strong> ${msg.message}`;
                }
                
                chatMessagesDiv.appendChild(messageDiv);
            });
            
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        // UPDATE ROOM DISPLAY - Real-time dari Supabase
        function updateRoomDisplay(room) {
            if (!room) {
                showError('Room tidak ditemukan!');
                leaveRoom();
                return;
            }
            
            console.log('Updating room display:', room);
            
            document.getElementById('displayRoomCode').innerHTML = 
                `ROOM-${gameData.roomCode} (${room.gameType})<br>
                 <button class="copy-btn" onclick="copyRoomCode()">📋 Copy Kode Room</button>`;
            
            document.getElementById('roomTaruhan').textContent = `Rp ${formatRupiah(room.taruhan)}`;
            document.getElementById('roomMode').textContent = `${getGameTypeDisplayName(room.gameType)}`;
            
            if (room.gameType === 'kbg') {
                document.getElementById('roomTeamMode').textContent = room.teamMode || '1v1';
            } else {
                document.getElementById('roomTeamMode').textContent = '1v1';
            }
            
            updateChatDisplay(room);
            
            // Tampilkan/sembunyikan komponen berdasarkan gameType
            if (room.gameType === 'kbg') {
                document.getElementById('dicePanel').style.display = 'none';
                document.getElementById('gameControls').style.display = 'block';
                
                // Update display berdasarkan mode tim
                if (room.teamMode && room.teamMode !== '1v1') {
                    document.getElementById('teamDisplay').style.display = 'block';
                    document.getElementById('playerDisplay').style.display = 'none';
                    updateTeamDisplay(room);
                } else {
                    document.getElementById('teamDisplay').style.display = 'none';
                    document.getElementById('playerDisplay').style.display = 'block';
                    updatePlayerDisplay(room);
                }
                
                // Update score display untuk multi-round modes
                if (room.gameMode !== 'single') {
                    document.getElementById('scoreDisplay').style.display = 'block';
                    document.getElementById('scoreValue').textContent = 
                        `${room.scores.teamA || 0} - ${room.scores.teamB || 0}`;
                    document.getElementById('roundInfo').textContent = `Ronde ${room.currentRound || 1}`;
                } else {
                    document.getElementById('scoreDisplay').style.display = 'none';
                }
            } else {
                // Mode Dadu
                document.getElementById('dicePanel').style.display = 'block';
                document.getElementById('gameControls').style.display = 'none';
                document.getElementById('teamDisplay').style.display = 'none';
                document.getElementById('playerDisplay').style.display = 'block';
                document.getElementById('scoreDisplay').style.display = 'none';
                
                // Update deskripsi game dadu
                const diceDescription = document.getElementById('diceGameDescription');
                if (room.gameType === 'dice1') {
                    diceDescription.textContent = 'Lempar 1 dadu, pemain dengan angka tertinggi menang!';
                } else {
                    diceDescription.textContent = 'Lempar 3 dadu, pemain dengan total angka tertinggi menang!';
                }
                
                updatePlayerDisplay(room);
            }
            
            // Update room status
            if (room.status === 'finished') {
                document.getElementById('roomStatus').textContent = 'Permainan selesai!';
                // Trigger cleanup untuk room yang sudah selesai
                cleanupFinishedRoom(gameData.roomCode);
                
                // Tampilkan hasil
                if (room.hasil) {
                    document.getElementById('hasilSection').style.display = 'block';
                    updateResultDisplay(room);
                }
            } else {
                // Cek apakah semua pemain sudah konfirmasi
                const allPlayers = [...room.teams.teamA, ...room.teams.teamB];
                const allConfirmed = allPlayers.filter(p => p.name).every(p => p.confirmed);
                
                if (allConfirmed) {
                    document.getElementById('roomStatus').textContent = 'Semua player READY!';
                    // Hitung hasil jika semua pemain sudah konfirmasi
                    if (room.gameType === 'kbg') {
                        setTimeout(() => calculateTeamResult(room), 1000);
                    } else {
                        setTimeout(() => calculateDiceResult(room), 1000);
                    }
                } else {
                    document.getElementById('roomStatus').textContent = 
                        room.teams.teamB.some(p => p.name) ? 'Silakan pilih dan konfirmasi...' : 'Menunggu player...';
                }
            }
            
            // Update player count
            const totalPlayers = room.teams.teamA.filter(p => p.name).length + 
                                room.teams.teamB.filter(p => p.name).length;
            const requiredPlayers = room.gameType === 'kbg' ? (room.teamSize || 1) * 2 : 2;
            document.getElementById('playerCount').textContent = `${totalPlayers}/${requiredPlayers}`;

            // Show/hide choice sections based on game state
            const currentPlayer = findCurrentPlayer(room);
            if (currentPlayer && !currentPlayer.confirmed && room.status !== 'finished') {
                if (room.gameType === 'kbg') {
                    document.getElementById('pilihanSection').style.display = 'block';
                    document.getElementById('confirmationSection').style.display = 'none';
                } else {
                    document.getElementById('rollDiceBtn').disabled = false;
                }
            } else {
                if (room.gameType === 'kbg') {
                    document.getElementById('pilihanSection').style.display = 'none';
                    document.getElementById('confirmationSection').style.display = 'none';
                } else {
                    document.getElementById('rollDiceBtn').disabled = true;
                }
            }

            // Show results if game finished
            if (room.status === 'finished' && room.hasil) {
                document.getElementById('hasilSection').style.display = 'block';
                updateResultDisplay(room);
            } else {
                document.getElementById('hasilSection').style.display = 'none';
            }
        }

        function updateTeamDisplay(room) {
            const teamSize = room.teamSize || 1;
            
            // Update team A
            let teamAHTML = '';
            room.teams.teamA.forEach(player => {
                const status = getPlayerStatus(player);
                teamAHTML += `
                    <div class="team-player ${status.class}">
                        <div><strong>${player.name || 'Menunggu...'}</strong></div>
                        <div>${status.text}</div>
                    </div>
                `;
            });
            document.getElementById('teamAPlayers').innerHTML = teamAHTML;
            
            // Update team B
            let teamBHTML = '';
            room.teams.teamB.forEach(player => {
                const status = getPlayerStatus(player);
                teamBHTML += `
                    <div class="team-player ${status.class}">
                        <div><strong>${player.name || 'Menunggu...'}</strong></div>
                        <div>${status.text}</div>
                    </div>
                `;
            });
            document.getElementById('teamBPlayers').innerHTML = teamBHTML;
        }

        function updatePlayerDisplay(room) {
            // Update player 1
            document.getElementById('player1Name').textContent = room.teams.teamA[0].name || '-';
            
            if (room.teams.teamA[0].confirmed) {
                document.getElementById('player1Status').textContent = '✅ READY';
                document.getElementById('player1Slot').className = 'player confirmed';
            } else if (room.teams.teamA[0].pilihan) {
                document.getElementById('player1Status').textContent = 'Memilih...';
                document.getElementById('player1Slot').className = 'player choosed';
            } else {
                document.getElementById('player1Status').textContent = 'Belum memilih';
                document.getElementById('player1Slot').className = 'player';
            }

            // Update player 2
            if (room.teams.teamB[0]) {
                document.getElementById('player2Name').textContent = room.teams.teamB[0].name || '-';
                
                if (room.teams.teamB[0].confirmed) {
                    document.getElementById('player2Status').textContent = '✅ READY';
                    document.getElementById('player2Slot').className = 'player confirmed';
                } else if (room.teams.teamB[0].pilihan) {
                    document.getElementById('player2Status').textContent = 'Memilih...';
                    document.getElementById('player2Slot').className = 'player choosed';
                } else {
                    document.getElementById('player2Status').textContent = 'Belum memilih';
                    document.getElementById('player2Slot').className = 'player';
                }
            } else {
                document.getElementById('player2Name').textContent = '-';
                document.getElementById('player2Status').textContent = 'Menunggu...';
                document.getElementById('player2Slot').className = 'player';
            }
        }

        function getPlayerStatus(player) {
            if (!player.name) {
                return { text: 'Menunggu...', class: '' };
            } else if (player.confirmed) {
                return { text: '✅ READY', class: 'confirmed' };
            } else if (player.pilihan) {
                return { text: 'Memilih...', class: 'choosed' };
            } else {
                return { text: 'Belum memilih', class: '' };
            }
        }

        function findCurrentPlayer(room) {
            const allPlayers = [...room.teams.teamA, ...room.teams.teamB];
            return allPlayers.find(player => player.playerNumber === gameData.playerNumber);
        }

        function selectChoice(pilihan) {
            gameData.tempChoice = pilihan;
            
            document.querySelectorAll('.btn-pilihan').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            document.getElementById('pilihanSection').style.display = 'none';
            document.getElementById('confirmationSection').style.display = 'block';
            document.getElementById('selectedChoice').textContent = pilihan.toUpperCase();
            
            playSound();
        }

        async function confirmChoice() {
            if (!gameData.tempChoice) {
                showError('Pilih pilihan dulu!');
                return;
            }

            const room = await getRoom(gameData.roomCode);
            if (!room) {
                showError('Room tidak ditemukan!');
                return;
            }

            const currentPlayer = findCurrentPlayer(room);
            if (!currentPlayer) {
                showError('Player tidak ditemukan!');
                return;
            }

            currentPlayer.pilihan = gameData.tempChoice;
            currentPlayer.confirmed = true;
            
            room.chatMessages.push({
                type: 'system',
                message: `✅ ${gameData.playerName} sudah memilih!`,
                timestamp: new Date().toISOString()
            });

            // Cek apakah semua pemain sudah memilih
            const allPlayers = [...room.teams.teamA, ...room.teams.teamB];
            const allConfirmed = allPlayers.filter(p => p.name).every(p => p.confirmed);
            
            if (allConfirmed) {
                setTimeout(() => calculateTeamResult(room), 1000);
            }
            
            const success = await saveRoom(gameData.roomCode, room);
            
            if (success) {
                showSuccess('Pilihan dikonfirmasi! ✅');
                resetChoiceUI();
                playSound();
            } else {
                showError('Gagal menyimpan pilihan! Coba lagi.');
            }
        }

        function cancelChoice() {
            resetChoiceUI();
            showSuccess('Pilihan dibatalkan');
            playSound();
        }

        // ==================== MODIFIKASI MPL/BO3 MENJADI SISTEM AKUMULASI SKOR ====================
        // Fungsi baru untuk menghitung hasil team
        async function calculateTeamResult(roomData) {
            let room = roomData;
            if (!room) {
                room = await getRoom(gameData.roomCode);
            }
            
            if (!room) return;
            
            const teamSize = room.teamSize || 1;
            let teamAPoints = 0;
            let teamBPoints = 0;
            
            // Hitung poin untuk setiap pertandingan antar pemain
            for (let i = 0; i < teamSize; i++) {
                const playerA = room.teams.teamA[i];
                const playerB = room.teams.teamB[i];
                
                if (!playerA.pilihan || !playerB.pilihan) continue;
                
                const result = determineWinner(playerA.pilihan, playerB.pilihan);
                
                if (result === 1) {
                    teamAPoints++;
                } else if (result === 2) {
                    teamBPoints++;
                }
                // Seri tidak memberikan poin
            }
            
            let roundWinner = null;
            let roundMessage = '';

            if (teamAPoints > teamBPoints) {
                roundWinner = 'teamA';
                roundMessage = `TEAM A menang Ronde ${room.currentRound}! (${teamAPoints}-${teamBPoints})`;
                room.scores.teamA = (room.scores.teamA || 0) + 1;
            } else if (teamBPoints > teamAPoints) {
                roundWinner = 'teamB';
                roundMessage = `TEAM B menang Ronde ${room.currentRound}! (${teamAPoints}-${teamBPoints})`;
                room.scores.teamB = (room.scores.teamB || 0) + 1;
            } else {
                roundWinner = 'seri';
                roundMessage = `Ronde ${room.currentRound} SERI! (${teamAPoints}-${teamBPoints})`;
            }

            // Simpan history ronde
            room.roundHistory.push({
                round: room.currentRound,
                teamAPoints: teamAPoints,
                teamBPoints: teamBPoints,
                winner: roundWinner,
                choices: {
                    teamA: room.teams.teamA.map(p => p.pilihan),
                    teamB: room.teams.teamB.map(p => p.pilihan)
                }
            });

            // Cek apakah game sudah selesai berdasarkan mode
            let gameFinished = false;
            let finalWinner = null;
            let finalMessage = '';

            if (room.gameMode === 'single') {
                gameFinished = true;
                finalWinner = roundWinner;
                finalMessage = roundWinner === 'seri' ? 'SERI!' : 
                             roundWinner === 'teamA' ? 'TEAM A MENANG! 🎉' : 
                             'TEAM B MENANG! 🎉';
            } 
            else if (room.gameMode === 'bo3') {
                // MODIFIKASI: Main 3 ronde penuh, lalu bandingkan skor
                if (room.currentRound >= 3) {
                    gameFinished = true;
                    
                    if (room.scores.teamA > room.scores.teamB) {
                        finalWinner = 'teamA';
                        finalMessage = `TEAM A MENANG MPL! 🏆 (${room.scores.teamA}-${room.scores.teamB})`;
                    } else if (room.scores.teamB > room.scores.teamA) {
                        finalWinner = 'teamB';
                        finalMessage = `TEAM B MENANG MPL! 🏆 (${room.scores.teamA}-${room.scores.teamB})`;
                    } else {
                        // Seri setelah 3 ronde - tie breaker
                        finalWinner = 'seri';
                        finalMessage = `SERI MPL! (${room.scores.teamA}-${room.scores.teamB})`;
                    }
                }
            }

            if (gameFinished) {
                // Tampilkan animasi pertarungan sebelum hasil akhir
                const teamAChoice = room.teams.teamA[0].pilihan;
                const teamBChoice = room.teams.teamB[0].pilihan;
                
                if (teamAChoice && teamBChoice) {
                    showBattleAnimation(teamAChoice, teamBChoice);
                    
                    // Tunggu animasi selesai sebelum melanjutkan
                    setTimeout(() => {
                        finishGame(room, finalWinner, finalMessage, teamSize);
                    }, 4000);
                } else {
                    finishGame(room, finalWinner, finalMessage, teamSize);
                }
            } else {
                // Lanjut ke ronde berikutnya
                room.currentRound++;
                
                // Reset pilihan semua pemain
                [...room.teams.teamA, ...room.teams.teamB].forEach(player => {
                    if (player.name) {
                        player.pilihan = null;
                        player.confirmed = false;
                    }
                });
                
                room.chatMessages.push({
                    type: 'system',
                    message: `🔄 ${roundMessage} Menuju Ronde ${room.currentRound}!`,
                    timestamp: new Date().toISOString()
                });
                
                await saveRoom(gameData.roomCode, room);
                playSound();
            }
        }

        function finishGame(room, finalWinner, finalMessage, teamSize) {
            let totalPot = room.taruhan * (teamSize * 2); // Total taruhan semua pemain
            let feeAdmin = calculateAdminFee(totalPot / 2); // Fee berdasarkan taruhan per orang
            let hadiahBersih = totalPot - feeAdmin;

            room.hasil = { 
                pemenang: finalWinner, 
                hasil: finalMessage,
                teamAPoints: room.scores.teamA || 0,
                teamBPoints: room.scores.teamB || 0,
                totalPot: totalPot,
                feeAdmin: feeAdmin,
                hadiahBersih: hadiahBersih,
                scores: room.scores,
                roundHistory: room.roundHistory
            };
            room.status = 'finished';
            
            room.chatMessages.push({
                type: 'system',
                message: `🏆 ${finalMessage}`,
                timestamp: new Date().toISOString()
            });

            // Simpan room setelah game selesai
            saveRoom(gameData.roomCode, room);
            
            // Tampilkan efek Victory/Defeat
            setTimeout(() => {
                if (finalWinner === 'seri') {
                    // Tidak tampilkan efek untuk seri
                } else {
                    const currentTeam = getCurrentPlayerTeam(room);
                    if (finalWinner === currentTeam) {
                        showVictory();
                    } else {
                        showDefeat();
                    }
                }
            }, 500);
            
            playSound();
        }

        function determineWinner(p1, p2) {
            if (p1 === p2) return 0; // Seri
            
            if (
                (p1 === 'batu' && p2 === 'gunting') ||
                (p1 === 'gunting' && p2 === 'kertas') ||
                (p1 === 'kertas' && p2 === 'batu')
            ) {
                return 1; // Player 1 menang
            }
            
            return 2; // Player 2 menang
        }

        function getCurrentPlayerTeam(room) {
            const currentPlayer = findCurrentPlayer(room);
            if (room.teams.teamA.some(p => p.playerNumber === currentPlayer.playerNumber)) {
                return 'teamA';
            }
            return 'teamB';
        }

        // Modifikasi updateResultDisplay untuk team mode
        function updateResultDisplay(room) {
            if (!room.hasil) return;

            const hasil = room.hasil;
            
            if (room.gameType === 'kbg') {
                // Tampilkan hasil untuk Kertas Batu Gunting
                let historyHTML = '';
                if (room.roundHistory && room.roundHistory.length > 0) {
                    historyHTML = '<div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">';
                    historyHTML += '<strong>Riwayat Ronde:</strong><br>';
                    room.roundHistory.forEach(round => {
                        let roundResult = '';
                        if (round.winner === 'seri') {
                            roundResult = 'SERI';
                        } else if (round.winner === 'teamA') {
                            roundResult = 'TEAM A Menang';
                        } else {
                            roundResult = 'TEAM B Menang';
                        }
                        historyHTML += `Ronde ${round.round}: ${round.teamAPoints}-${round.teamBPoints} → ${roundResult}<br>`;
                    });
                    historyHTML += `</div><p><strong>Final Score: ${room.scores.teamA} - ${room.scores.teamB}</strong></p>`;
                }
                
                // Tampilkan pilihan semua pemain
                let choicesHTML = '<div style="display: flex; justify-content: space-between; margin: 10px 0;">';
                
                // Team A choices
                choicesHTML += '<div style="flex: 1; text-align: center;">';
                choicesHTML += '<strong>TEAM A:</strong><br>';
                room.teams.teamA.forEach((player, index) => {
                    choicesHTML += `${player.name}: ${player.pilihan ? player.pilihan.toUpperCase() : 'BELUM MEMILIH'}<br>`;
                });
                choicesHTML += '</div>';
                
                // VS
                choicesHTML += '<div style="flex: 0; padding: 0 20px; align-self: center;">VS</div>';
                
                // Team B choices
                choicesHTML += '<div style="flex: 1; text-align: center;">';
                choicesHTML += '<strong>TEAM B:</strong><br>';
                room.teams.teamB.forEach((player, index) => {
                    choicesHTML += `${player.name}: ${player.pilihan ? player.pilihan.toUpperCase() : 'BELUM MEMILIH'}<br>`;
                });
                choicesHTML += '</div>';
                
                choicesHTML += '</div>';
                
                document.getElementById('hasilPertandingan').innerHTML = `
                    ${historyHTML}
                    ${choicesHTML}
                `;

                const statusElement = document.getElementById('statusPemenang');
                statusElement.textContent = hasil.hasil;
                statusElement.className = hasil.pemenang === 'seri' ? 'seri' : 'menang';

                let pembayaranHTML = '';
                if (hasil.pemenang === 'seri') {
                    pembayaranHTML = `
                        <p>💰 Total Taruhan: Rp ${formatRupiah(hasil.totalPot)}</p>
                        <p>🏦 Fee Admin: Rp ${formatRupiah(hasil.feeAdmin)}</p>
                        <p>🔙 Dana dikembalikan ke masing-masing player</p>
                    `;
                } else {
                    const pemenangName = hasil.pemenang === 'teamA' ? 'TEAM A' : 'TEAM B';
                    const teamSize = room.teamSize || 1;
                    const hadiahPerPlayer = Math.floor(hasil.hadiahBersih / teamSize);
                    
                    pembayaranHTML = `
                        <p>💰 Total Pot: Rp ${formatRupiah(hasil.totalPot)}</p>
                        <p>🏦 Fee Admin: Rp ${formatRupiah(hasil.feeAdmin)}</p>
                        <p>🎁 Hadiah Bersih: Rp ${formatRupiah(hasil.hadiahBersih)}</p>
                        <p>👑 ${pemenangName} mendapatkan: Rp ${formatRupiah(hadiahPerPlayer)} per pemain</p>
                    `;
                }
                
                document.getElementById('pembayaranInfo').innerHTML = pembayaranHTML;
            } else {
                // Tampilkan hasil untuk Dadu
                let resultsHTML = '<div style="margin: 10px 0;">';
                
                hasil.playerScores.forEach(score => {
                    if (score.values.length === 1) {
                        resultsHTML += `<div style="margin: 5px 0;">${score.player.name}: ${score.values[0]}</div>`;
                    } else {
                        resultsHTML += `<div style="margin: 5px 0;">${score.player.name}: ${score.values.join(' + ')} = ${score.total}</div>`;
                    }
                });
                
                resultsHTML += '</div>';
                
                document.getElementById('hasilPertandingan').innerHTML = resultsHTML;

                const statusElement = document.getElementById('statusPemenang');
                statusElement.textContent = hasil.hasil;
                statusElement.className = 'menang';

                // Hitung pembayaran
                let totalPot = room.taruhan * 2; // 2 pemain
                let feeAdmin = calculateAdminFee(totalPot / 2);
                let hadiahBersih = totalPot - feeAdmin;
                
                let pembayaranHTML = '';
                if (hasil.pemenang === 'seri') {
                    pembayaranHTML = `
                        <p>💰 Total Taruhan: Rp ${formatRupiah(totalPot)}</p>
                        <p>🏦 Fee Admin: Rp ${formatRupiah(feeAdmin)}</p>
                        <p>🔙 Dana dikembalikan ke masing-masing player</p>
                    `;
                } else {
                    const pemenangName = hasil.pemenang === 'teamA' ? room.teams.teamA[0].name : room.teams.teamB[0].name;
                    pembayaranHTML = `
                        <p>💰 Total Pot: Rp ${formatRupiah(totalPot)}</p>
                        <p>🏦 Fee Admin: Rp ${formatRupiah(feeAdmin)}</p>
                        <p>🎁 Hadiah Bersih: Rp ${formatRupiah(hadiahBersih)}</p>
                        <p>👑 ${pemenangName} mendapatkan: Rp ${formatRupiah(hadiahBersih)}</p>
                    `;
                }
                
                document.getElementById('pembayaranInfo').innerHTML = pembayaranHTML;
            }
        }

        // Modifikasi rematch untuk team mode
        async function rematch() {
            hideOverlay();
            
            const room = await getRoom(gameData.roomCode);
            
            // Reset pilihan semua pemain
            [...room.teams.teamA, ...room.teams.teamB].forEach(player => {
                if (player.name) {
                    player.pilihan = null;
                    player.confirmed = false;
                }
            });
            
            room.status = 'ready';
            room.hasil = null;
            room.showChoices = false;
            room.scores = { teamA: 0, teamB: 0 };
            room.currentRound = 1;
            room.roundHistory = [];
            
            room.chatMessages.push({
                type: 'system',
                message: '🔄 Memulai permainan baru!',
                timestamp: new Date().toISOString()
            });
            
            document.getElementById('hasilSection').style.display = 'none';
            await saveRoom(gameData.roomCode, room);
            resetChoiceUI();
            playSound();
        }

        // Modifikasi leaveRoom untuk team mode
        async function leaveRoom() {
            hideOverlay();
            stopRoomListener();
            
            const room = await getRoom(gameData.roomCode);
            if (room) {
                // Cari dan hapus player yang leave
                const allPlayers = [...room.teams.teamA, ...room.teams.teamB];
                const playerIndex = allPlayers.findIndex(p => p.playerNumber === gameData.playerNumber);
                
                if (playerIndex !== -1) {
                    // Tentukan team player
                    const team = room.teams.teamA.some(p => p.playerNumber === gameData.playerNumber) ? 'teamA' : 'teamB';
                    const playerInTeam = room.teams[team].find(p => p.playerNumber === gameData.playerNumber);
                    
                    if (playerInTeam) {
                        playerInTeam.name = null;
                        playerInTeam.pilihan = null;
                        playerInTeam.confirmed = false;
                    }
                }
                
                room.chatMessages.push({
                    type: 'system',
                    message: `🚪 ${gameData.playerName} meninggalkan room`,
                    timestamp: new Date().toISOString()
                });
                
                // Jika creator leave, hapus room
                if (gameData.isCreator) {
                    await deleteRoom(gameData.roomCode);
                } else {
                    await saveRoom(gameData.roomCode, room);
                }
            }
            
            showSection('sectionLobby');
            updateRoomStats();
            playSound();
        }

        function formatRupiah(angka) {
            return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Fungsi bantu untuk mendapatkan nama tampilan game type
        function getGameTypeDisplayName(gameType) {
            switch(gameType) {
                case 'kbg': return 'Kertas Batu Gunting';
                case 'dice1': return 'Dadu Tunggal';
                case 'dice3': return '3 Dadu';
                default: return 'Kertas Batu Gunting';
            }
        }

        // Test koneksi Supabase
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('rooms')
                    .select('count')
                    .limit(1);
                
                const statusElement = document.getElementById('connectionStatus');
                const detailsElement = document.getElementById('connectionDetails');
                
                if (error) {
                    statusElement.textContent = '❌ Gagal';
                    detailsElement.textContent = `Error: ${error.message}`;
                    
                    // Cek apakah tabel 'rooms' ada
                    if (error.message.includes('does not exist')) {
                        showError('Tabel "rooms" belum dibuat di Supabase. Silakan buat tabel terlebih dahulu.');
                    }
                } else {
                    statusElement.textContent = '✅ Terhubung';
                    detailsElement.textContent = '';
                }
            } catch (error) {
                console.error('Connection test error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default player name
            document.getElementById('playerName').value = gameData.playerName;
            updateRoomStats();
            
            // Test koneksi Supabase
            testSupabaseConnection();
            
            // Start auto-cleanup (setiap 6 jam)
            setInterval(cleanupOldRooms, 6 * 60 * 60 * 1000);
            
            // Run cleanup sekali saat start
            setTimeout(cleanupOldRooms, 5000);
            
            console.log('Game initialized with Supabase + Auto-Cleanup + Team Mode + Victory/Defeat Effects + Team Selection + Battle Animation + MPL Score System + DICE MODE');
        });
    </script>
</body>
</html>