<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertas Batu Gunting - Gaming Theme</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(15, 22, 39, 0.85);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(64, 224, 208, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00FFFF, #FF00FF, #00FFFF);
            border-radius: 15px 15px 0 0;
        }
        
        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            letter-spacing: 1px;
        }
        
        .subtitle {
            text-align: center;
            color: #a0a0ff;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(30, 35, 60, 0.7);
            border-radius: 10px;
            display: none;
            border: 1px solid rgba(100, 100, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #a0a0ff;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(100, 100, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            background: rgba(20, 25, 45, 0.8);
            color: #fff;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #00FFFF;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            outline: none;
        }
        
        input[type="number"] {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 5px 0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 180, 155, 0.4);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #00917a, #7da82a);
            box-shadow: 0 6px 20px rgba(0, 180, 155, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #8e2de2, #4a00e0);
            color: white;
            box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7a1fc9, #3d00b8);
            box-shadow: 0 6px 20px rgba(142, 45, 226, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f46b45, #eea849);
            color: black;
            box-shadow: 0 4px 15px rgba(244, 107, 69, 0.4);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e05a3a, #dc973c);
            box-shadow: 0 6px 20px rgba(244, 107, 69, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e6375f, #e63e1f);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.4);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #00a8e0, #005fdb);
            box-shadow: 0 6px 20px rgba(0, 198, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .room-info {
            background: rgba(30, 60, 50, 0.6);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(0, 255, 150, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .player-list {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            gap: 10px;
        }
        
        .player {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: rgba(20, 25, 45, 0.8);
            border-radius: 8px;
            border: 2px dashed rgba(100, 100, 255, 0.3);
            transition: all 0.3s;
        }
        
        .player.ready {
            border: 2px solid #00FF88;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }
        
        .player.choosed {
            border: 2px solid #00AAFF;
            background: rgba(0, 170, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.3);
        }
        
        .player.confirmed {
            border: 2px solid #FFAA00;
            background: rgba(255, 170, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
        }
        
        .player h4 {
            color: #a0a0ff;
            margin-bottom: 5px;
        }
        
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .pilihan-section {
            display: none;
        }
        
        .pilihan-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .btn-pilihan {
            flex: 1;
            padding: 15px;
            background: rgba(30, 35, 60, 0.8);
            color: white;
            border: 2px solid rgba(100, 100, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .btn-pilihan:hover {
            background: rgba(50, 55, 90, 0.8);
            border-color: #00AAFF;
            transform: translateY(-3px);
        }
        
        .btn-pilihan.selected {
            background: rgba(0, 170, 255, 0.2);
            border: 3px solid #00AAFF;
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.5);
        }
        
        .btn-pilihan:disabled {
            background: rgba(60, 60, 80, 0.5);
            cursor: not-allowed;
            border-color: rgba(100, 100, 100, 0.3);
        }
        
        .confirmation-section {
            display: none;
            text-align: center;
            padding: 15px;
            background: rgba(0, 50, 100, 0.5);
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(0, 170, 255, 0.3);
        }
        
        .hasil-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            background: rgba(30, 35, 60, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }
        
        .menang { 
            color: #00FF88; 
            font-weight: bold; 
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.7);
        }
        
        .kalah { 
            color: #FF416C; 
            font-weight: bold; 
            text-shadow: 0 0 10px rgba(255, 65, 108, 0.7);
        }
        
        .seri { 
            color: #FFAA00; 
            font-weight: bold; 
            text-shadow: 0 0 10px rgba(255, 170, 0, 0.7);
        }
        
        .admin-fee {
            background: rgba(255, 200, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }
        
        .room-code {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 3px;
            background: linear-gradient(135deg, #8e2de2, #4a00e0);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
            box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .copy-btn {
            background: rgba(0, 198, 255, 0.8);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: rgba(0, 170, 230, 1);
            transform: translateY(-2px);
        }

        .error-message {
            background: rgba(255, 65, 108, 0.2);
            color: #ff8fa3;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
            border: 1px solid rgba(255, 65, 108, 0.5);
        }

        .success-message {
            background: rgba(0, 255, 136, 0.2);
            color: #88ffc6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .choice-preview {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 200, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .room-stats {
            background: rgba(30, 35, 60, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid rgba(100, 100, 255, 0.2);
        }

        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: #00FFFF;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }

        .stats-label {
            font-size: 14px;
            color: #a0a0ff;
        }

        .join-info {
            background: rgba(255, 200, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #ffcc00;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .chat-section {
            margin: 15px 0;
            border: 2px solid rgba(100, 100, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(20, 25, 45, 0.8);
        }

        .chat-header {
            background: linear-gradient(135deg, #8e2de2, #4a00e0);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .chat-messages {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(15, 20, 35, 0.8);
            border-bottom: 1px solid rgba(100, 100, 255, 0.2);
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
        }

        .chat-message.system {
            background: rgba(255, 200, 0, 0.1);
            text-align: center;
            font-style: italic;
            color: #ffcc00;
            border-left: 3px solid #ffcc00;
        }

        .chat-message.player {
            background: rgba(0, 170, 255, 0.1);
            border-left: 3px solid #00AAFF;
        }

        .chat-message.opponent {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00FF88;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            background: rgba(30, 35, 60, 0.8);
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 5px;
            margin-right: 10px;
            background: rgba(20, 25, 45, 0.8);
            color: white;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: linear-gradient(135deg, #00917a, #7da82a);
            transform: translateY(-2px);
        }

        .chat-send-btn:disabled {
            background: rgba(60, 60, 80, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .sound-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .sound-btn {
            background: rgba(15, 22, 39, 0.8);
            border: 2px solid rgba(100, 100, 255, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            color: white;
        }

        .sound-btn:hover {
            background: rgba(30, 35, 60, 0.9);
            transform: scale(1.1);
            border-color: #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .sound-btn.muted {
            background: rgba(255, 65, 108, 0.8);
            border-color: rgba(255, 65, 108, 0.7);
        }

        .loading {
            text-align: center;
            padding: 10px;
            color: #a0a0ff;
        }

        .debug-info {
            background: rgba(30, 35, 60, 0.7);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #a0a0ff;
            display: none;
        }

        .game-mode-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .mode-option {
            flex: 1;
            padding: 12px;
            background: rgba(30, 35, 60, 0.8);
            border: 2px solid rgba(100, 100, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .mode-option:hover {
            background: rgba(50, 55, 90, 0.8);
            border-color: #00AAFF;
        }

        .mode-option.selected {
            background: rgba(0, 170, 255, 0.2);
            border: 2px solid #00AAFF;
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
        }

        .mode-option h4 {
            color: #a0a0ff;
            margin-bottom: 5px;
        }

        .mode-option .price {
            font-size: 12px;
            color: #00FF88;
        }

        .score-display {
            background: rgba(0, 50, 100, 0.5);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid rgba(0, 170, 255, 0.3);
        }

        .score-title {
            font-size: 14px;
            color: #a0a0ff;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 18px;
            font-weight: bold;
            color: #00FFFF;
        }

        .round-info {
            background: rgba(255, 200, 0, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            text-align: center;
            font-size: 14px;
            color: #ffcc00;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20, 25, 45, 0.8);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 255, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 100, 255, 0.7);
        }
    </style>
    
    <!-- SUPABASE SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="sound-controls">
        <button class="sound-btn" id="soundToggle" onclick="toggleSound()">🔊</button>
    </div>

    <div class="container">
        <h1>🎮 KERTAS BATU GUNTING</h1>
        <div class="subtitle">Powered By CILL</div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- Debug info untuk troubleshooting -->
        <div class="debug-info" id="debugInfo"></div>
        
        <!-- Section 1: Create or Join Room -->
        <div class="section active" id="sectionLobby">
            <div class="input-group">
                <label>Nama Player:</label>
                <input type="text" id="playerName" placeholder="Masukkan nama kamu" value="Player">
            </div>
            
            <button class="btn btn-primary" onclick="showCreateRoom()">➕ BUAT ROOM</button>
            <button class="btn btn-secondary" onclick="showJoinRoom()">🔗 JOIN ROOM</button>

            <div class="room-stats">
                <h4>📊 STATUS KONEKSI</h4>
                <div class="stats-number" id="connectionStatus">Mengecek...</div>
                <div class="stats-label" id="connectionDetails">Koneksi ke Supabase</div>
                
                <div class="join-info">
                    💡 <strong>Cara Main:</strong><br>
                    1. Buat room baru ATAU join dengan kode room<br>
                    2. Share kode room ke teman untuk bermain
                </div>
            </div>
        </div>
        
        <!-- Section 2: Create Room -->
        <div class="section" id="sectionCreate">
            <h3>Buat Room Baru</h3>
            <div class="input-group">
                <label>Taruhan:</label>
                <input type="text" id="createTaruhan" placeholder="Contoh: 10.000" value="5.000" oninput="formatRupiahInput(this)">
            </div>
            
            <div class="input-group">
                <label>Pilih Mode Permainan:</label>
                <div class="game-mode-selector">
                    <div class="mode-option selected" onclick="selectGameMode('single')">
                        <h4>🎯 SINGLE ROUND</h4>
                        <p>1 Ronde Penentu</p>
                        <p class="price">Taruhan Normal</p>
                    </div>
                    <div class="mode-option" onclick="selectGameMode('bo3')">
                        <h4>⚔️ MPL</h4>
                        <p>Pemenang 2/3 Ronde</p>
                        <p class="price">Taruhan Normal</p>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label>Room Password (optional):</label>
                <input type="text" id="roomPassword" placeholder="Password room (bisa dikosongkan)">
            </div>
            <button class="btn btn-primary" onclick="createRoom()">🎯 BUAT ROOM</button>
            <button class="btn btn-secondary" onclick="backToLobby()">⬅ KEMBALI</button>
        </div>
        
        <!-- Section 3: Join Room -->
        <div class="section" id="sectionJoin">
            <h3>Join Room</h3>
            
            <div class="join-info">
                💡 <strong>Minta kode room</strong> dari teman yang sudah buat room
            </div>
            
            <div class="input-group">
                <label>Kode Room:</label>
                <input type="text" id="joinRoomCode" placeholder="Masukkan kode room dari teman" style="text-transform: uppercase;">
            </div>
            <div class="input-group">
                <label>Password Room (jika ada):</label>
                <input type="text" id="joinPassword" placeholder="Masukkan password room">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">🎮 JOIN ROOM</button>
            <button class="btn btn-secondary" onclick="backToLobby()">⬅ KEMBALI</button>
        </div>
        
        <!-- Section 4: Game Room -->
        <div class="section" id="sectionGame">
            <div class="room-code" id="displayRoomCode">
                ROOM-XXXX
                <br>
                <button class="copy-btn" onclick="copyRoomCode()">📋 Copy Kode Room</button>
            </div>
            
            <div class="room-info">
                <p>Mode: <strong id="roomMode">Single Round</strong></p>
                <p>Taruhan: <strong id="roomTaruhan">Rp 0</strong></p>
                <p>Status: <strong id="roomStatus">Menunggu player...</strong></p>
                <p>Pemain: <span id="playerCount">1/2</span></p>
            </div>

            <!-- Score Display -->
            <div class="score-display" id="scoreDisplay" style="display: none;">
                <div class="score-title">SCORE SEMENTARA</div>
                <div class="score-value" id="scoreValue">0 - 0</div>
                <div class="round-info" id="roundInfo">Ronde 1</div>
            </div>
            
            <!-- Chat Room -->
            <div class="chat-section" id="chatSection">
                <div class="chat-header">💬 Chat Room</div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message system">
                        💡 Selamat datang di chat room! Gunakan untuk berkomunikasi dengan lawan.
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." maxlength="100">
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Kirim</button>
                </div>
            </div>
            
            <div class="player-list">
                <div class="player" id="player1Slot">
                    <h4>Player 1</h4>
                    <div id="player1Name">-</div>
                    <div id="player1Status">Menunggu...</div>
                </div>
                <div class="player" id="player2Slot">
                    <h4>Player 2</h4>
                    <div id="player2Name">-</div>
                    <div id="player2Status">Menunggu...</div>
                </div>
            </div>
            
            <div class="game-controls" id="gameControls">
                <!-- Pilihan Section -->
                <div class="pilihan-section" id="pilihanSection">
                    <h4>Pilih Salah Satu:</h4>
                    <div class="pilihan-buttons">
                        <button class="btn-pilihan" onclick="selectChoice('kertas')">📄 Kertas</button>
                        <button class="btn-pilihan" onclick="selectChoice('batu')">🪨 Batu</button>
                        <button class="btn-pilihan" onclick="selectChoice('gunting')">✂️ Gunting</button>
                    </div>
                </div>
                
                <!-- Confirmation Section -->
                <div class="confirmation-section" id="confirmationSection">
                    <div class="choice-preview" id="choicePreview">
                        Anda memilih: <span id="selectedChoice">-</span>
                    </div>
                    <p>Yakin dengan pilihan ini?</p>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-warning" onclick="confirmChoice()">✅ YA, READY!</button>
                        <button class="btn btn-secondary" onclick="cancelChoice()">❌ BATAL</button>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="leaveRoom()">🚪 KELUAR ROOM</button>
            
            <div class="hasil-section" id="hasilSection" style="display: none;">
                <h3>🏆 HASIL PERMAINAN</h3>
                <div id="hasilPertandingan"></div>
                <div id="statusPemenang"></div>
                <div class="admin-fee" id="pembayaranInfo"></div>
                <button class="btn btn-primary" onclick="rematch()">🔄 MAIN LAGI</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://dmxcnbsxgrjjvprkmuar.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRteGNuYnN4Z3JqanZwcmttdWFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzE1NDUsImV4cCI6MjA3NTYwNzU0NX0.LQAfUnB7tMGPvDyNzu2hBYZ7RVl5Glvu_OaIekJ-LeE';
        
        // Inisialisasi Supabase dengan cara yang benar
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==================== GAME DATA ====================
        let gameData = {
            playerName: 'Player',
            roomCode: '',
            isCreator: false,
            playerNumber: 0,
            tempChoice: null,
            soundEnabled: true,
            roomSubscription: null,
            gameMode: 'single' // single, bo3
        };

        // ==================== AUTO CLEANUP FUNCTIONS ====================
        async function cleanupOldRooms() {
            try {
                console.log('🔄 Running auto-cleanup...');
                const rooms = await getAllRooms();
                const now = new Date();
                let deletedCount = 0;

                for (const [roomCode, roomData] of Object.entries(rooms)) {
                    // Skip if room doesn't have createdAt
                    if (!roomData.createdAt) continue;
                    
                    const roomAge = now - new Date(roomData.createdAt);
                    const ageInHours = roomAge / (1000 * 60 * 60);
                    
                    // Delete rooms older than 24 hours
                    if (ageInHours > 24) {
                        await deleteRoom(roomCode);
                        deletedCount++;
                        console.log(`🧹 Deleted old room: ${roomCode} (${ageInHours.toFixed(1)} hours old)`);
                    }
                }
                
                if (deletedCount > 0) {
                    console.log(`✅ Cleanup completed: ${deletedCount} rooms deleted`);
                }
            } catch (error) {
                console.error('❌ Cleanup error:', error);
            }
        }

        // Cleanup room setelah game selesai
        async function cleanupFinishedRoom(roomCode) {
            setTimeout(async () => {
                await deleteRoom(roomCode);
                console.log(`🧹 Auto-deleted finished room: ${roomCode}`);
            }, 5 * 60 * 1000); // 5 menit setelah game selesai
        }

        // ==================== SUPABASE FUNCTIONS ====================
        async function getRoom(roomCode) {
            try {
                const { data, error } = await supabase
                    .from('rooms')
                    .select('*')
                    .eq('code', roomCode)
                    .single();
                    
                if (error) {
                    console.log('Room not found:', roomCode, error);
                    return null;
                }
                return data.data;
            } catch (error) {
                console.error('Error getting room:', error);
                return null;
            }
        }

        async function saveRoom(roomCode, roomData) {
            try {
                // Debug info
                updateDebugInfo(`Menyimpan room: ${roomCode}`);
                
                const { data, error } = await supabase
                    .from('rooms')
                    .upsert({
                        code: roomCode,
                        data: roomData,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'code'
                    });
                    
                if (error) {
                    console.error('Supabase save error:', error);
                    updateDebugInfo(`Error: ${error.message}`);
                    return false;
                }
                console.log('Room saved successfully:', roomCode);
                updateDebugInfo(`Room ${roomCode} berhasil disimpan`);
                return true;
            } catch (error) {
                console.error('Error saving room:', error);
                updateDebugInfo(`Exception: ${error.message}`);
                return false;
            }
        }

        async function deleteRoom(roomCode) {
            try {
                const { error } = await supabase
                    .from('rooms')
                    .delete()
                    .eq('code', roomCode);
                    
                return !error;
            } catch (error) {
                console.error('Error deleting room:', error);
                return false;
            }
        }

        async function getAllRooms() {
            try {
                const { data, error } = await supabase
                    .from('rooms')
                    .select('code, data');
                    
                if (error) {
                    console.error('Error getting rooms:', error);
                    return {};
                }
                
                const roomsMap = {};
                if (data) {
                    data.forEach(room => {
                        roomsMap[room.code] = room.data;
                    });
                }
                return roomsMap;
            } catch (error) {
                console.error('Error getting all rooms:', error);
                return {};
            }
        }

        function startRoomListener(roomCode, callback) {
            console.log('Starting realtime listener for:', roomCode);
            
            // Unsubscribe existing listener if any
            if (gameData.roomSubscription) {
                gameData.roomSubscription.unsubscribe();
            }

            const subscription = supabase
                .channel('room-changes')
                .on('postgres_changes', 
                    {
                        event: '*',
                        schema: 'public',
                        table: 'rooms',
                        filter: `code=eq.${roomCode}`
                    },
                    (payload) => {
                        console.log('Realtime update:', payload);
                        if (payload.new && payload.new.data) {
                            callback(payload.new.data);
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });

            gameData.roomSubscription = subscription;
            return subscription;
        }

        function stopRoomListener() {
            if (gameData.roomSubscription) {
                gameData.roomSubscription.unsubscribe();
                gameData.roomSubscription = null;
                console.log('Room listener stopped');
            }
        }

        // ==================== GAME FUNCTIONS ====================
        function selectGameMode(mode) {
            gameData.gameMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            playSound();
        }

        function calculateAdminFee(taruhan) {
            if (taruhan >= 1 && taruhan <= 9500) return 1000;
            if (taruhan >= 10000 && taruhan <= 19900) return 2000;
            if (taruhan >= 20000 && taruhan <= 29900) return 3000;
            if (taruhan >= 30000 && taruhan <= 39900) return 4000;
            if (taruhan >= 40000 && taruhan <= 49900) return 5000;
            if (taruhan >= 50000 && taruhan <= 59900) return 6000;
            if (taruhan >= 60000 && taruhan <= 69900) return 7000;
            if (taruhan >= 70000 && taruhan <= 79900) return 8000;
            if (taruhan >= 80000 && taruhan <= 89900) return 9000;
            if (taruhan >= 90000 && taruhan <= 99900) return 10000;
            if (taruhan >= 100000) return Math.floor(taruhan / 10000) * 1000;
            return 1000;
        }

        function playSound() {
            if (!gameData.soundEnabled) return;
            // Simple sound implementation
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.log('Sound not supported');
            }
        }

        function toggleSound() {
            gameData.soundEnabled = !gameData.soundEnabled;
            const soundBtn = document.getElementById('soundToggle');
            soundBtn.textContent = gameData.soundEnabled ? '🔊' : '🔇';
            soundBtn.classList.toggle('muted', !gameData.soundEnabled);
            showSuccess(gameData.soundEnabled ? 'Sound diaktifkan' : 'Sound dimatikan');
            playSound();
        }

        function formatRupiahInput(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('id-ID');
                input.value = value;
            }
        }

        function parseRupiahInput(inputValue) {
            return parseInt(inputValue.replace(/[^\d]/g, '') || 0);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
            playSound();
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function updateDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `<strong>Debug:</strong> ${message}`;
            debugDiv.style.display = 'block';
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function showCreateRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('Masukkan nama dulu!');
                document.getElementById('playerName').focus();
                return;
            }
            gameData.playerName = playerName;
            showSection('sectionCreate');
            playSound();
        }

        function showJoinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('Masukkan nama dulu!');
                document.getElementById('playerName').focus();
                return;
            }
            gameData.playerName = playerName;
            updateRoomStats();
            showSection('sectionJoin');
            playSound();
        }

        function backToLobby() {
            showSection('sectionLobby');
            updateRoomStats();
            playSound();
        }

        async function updateRoomStats() {
            try {
                const rooms = await getAllRooms();
                const roomCountElement = document.getElementById('roomCount');
                
                const activeRooms = Object.entries(rooms).filter(([code, room]) => {
                    return room && room.status === 'waiting' && !room.player2;
                });
                
                roomCountElement.textContent = activeRooms.length;
            } catch (error) {
                console.error('Error updating room stats:', error);
            }
        }

        // CREATE ROOM dengan Supabase - DIPERBAIKI
        async function createRoom() {
            const taruhanInput = document.getElementById('createTaruhan').value;
            const password = document.getElementById('roomPassword').value;
            
            const taruhan = parseRupiahInput(taruhanInput);
            if (!taruhan || taruhan <= 0) {
                showError('Masukkan jumlah taruhan yang valid!');
                return;
            }

            if (taruhan < 1000) {
                showError('Taruhan minimal Rp 1.000!');
                return;
            }

            updateDebugInfo(`Membuat room dengan taruhan: ${taruhan}, mode: ${gameData.gameMode}`);

            let roomCode;
            let attempts = 0;
            let rooms = await getAllRooms();
            
            do {
                roomCode = generateRoomCode();
                attempts++;
            } while (rooms[roomCode] && attempts < 10);

            if (attempts >= 10) {
                showError('Gagal membuat room, coba lagi!');
                return;
            }

            gameData.roomCode = roomCode;
            gameData.isCreator = true;
            gameData.playerNumber = 1;

            const roomData = {
                password: password,
                taruhan: taruhan,
                gameMode: gameData.gameMode,
                player1: { 
                    name: gameData.playerName, 
                    pilihan: null, 
                    confirmed: false
                },
                player2: null,
                status: 'waiting',
                hasil: null,
                scores: { player1: 0, player2: 0 },
                currentRound: 1,
                roundHistory: [],
                createdAt: new Date().toISOString(),
                showChoices: false,
                showResult: false,
                chatMessages: [{
                    type: 'system',
                    message: `🎮 ${gameData.playerName} membuat room! Mode: ${getModeDisplayName(gameData.gameMode)}`,
                    timestamp: new Date().toISOString()
                }]
            };

            console.log('Creating room:', roomCode, roomData);
            updateDebugInfo(`Room data: ${JSON.stringify(roomData)}`);
            
            const success = await saveRoom(roomCode, roomData);
            if (success) {
                showSuccess('Room ' + roomCode + ' berhasil dibuat! 🎉');
                enterGameRoom();
                playSound();
            } else {
                showError('Gagal membuat room! Coba lagi. Periksa koneksi database.');
            }
        }

        function getModeDisplayName(mode) {
            switch(mode) {
                case 'single': return 'Single Round';
                case 'bo3': return 'Best of 3';
                default: return 'Single Round';
            }
        }

        // JOIN ROOM dengan Supabase - DIPERBAIKI
        async function joinRoom() {
            const roomCodeInput = document.getElementById('joinRoomCode');
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            const password = document.getElementById('joinPassword').value;
            
            if (!roomCode) {
                showError('Masukkan kode room!');
                roomCodeInput.focus();
                return;
            }

            if (roomCode.length !== 4) {
                showError('Kode room harus 4 karakter!');
                roomCodeInput.focus();
                return;
            }

            console.log('Joining room:', roomCode);
            updateDebugInfo(`Mencoba join room: ${roomCode}`);
            
            const room = await getRoom(roomCode);
            if (!room) {
                showError('Room ' + roomCode + ' tidak ditemukan! Pastikan kode room benar.');
                return;
            }

            if (room.password && room.password !== password) {
                showError('Password room salah!');
                return;
            }

            if (room.player2) {
                showError('Room sudah penuh!');
                return;
            }

            if (room.status === 'finished') {
                showError('Room sudah selesai! Buat room baru atau join room lain.');
                return;
            }

            gameData.roomCode = roomCode;
            gameData.isCreator = false;
            gameData.playerNumber = 2;
            gameData.gameMode = room.gameMode || 'single';

            room.player2 = { 
                name: gameData.playerName, 
                pilihan: null, 
                confirmed: false
            };
            room.status = 'ready';
            
            room.chatMessages.push({
                type: 'system',
                message: `🎮 ${gameData.playerName} bergabung ke room!`,
                timestamp: new Date().toISOString()
            });

            console.log('Saving joined room:', room);
            updateDebugInfo(`Room data setelah join: ${JSON.stringify(room)}`);
            
            const success = await saveRoom(roomCode, room);
            if (success) {
                showSuccess('Berhasil join room ' + roomCode + '! 🎮');
                enterGameRoom();
                playSound();
            } else {
                showError('Gagal join room! Coba lagi.');
            }
        }

        function copyRoomCode() {
            const roomCode = gameData.roomCode;
            navigator.clipboard.writeText(roomCode).then(function() {
                showSuccess('Kode room disalin: ' + roomCode);
            }).catch(function(err) {
                // Fallback untuk browser lama
                const tempInput = document.createElement('input');
                tempInput.value = roomCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showSuccess('Kode room disalin: ' + roomCode);
            });
            playSound();
        }

        function enterGameRoom() {
            showSection('sectionGame');
            resetChoiceUI();
            startRoomListener(gameData.roomCode, updateRoomDisplay);
            
            // Setup chat input
            const chatInput = document.getElementById('chatInput');
            chatInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            };
            
            // Load initial room state
            loadRoomState();
        }

        async function loadRoomState() {
            const room = await getRoom(gameData.roomCode);
            if (room) {
                updateRoomDisplay(room);
            }
        }

        function resetChoiceUI() {
            document.getElementById('pilihanSection').style.display = 'block';
            document.getElementById('confirmationSection').style.display = 'none';
            gameData.tempChoice = null;
            
            document.querySelectorAll('.btn-pilihan').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            const room = await getRoom(gameData.roomCode);
            if (!room) return;
            
            room.chatMessages.push({
                type: 'player',
                player: gameData.playerName,
                message: message,
                timestamp: new Date().toISOString()
            });
            
            await saveRoom(gameData.roomCode, room);
            chatInput.value = '';
            playSound();
        }

        function updateChatDisplay(room) {
            if (!room || !room.chatMessages) return;
            
            const chatMessagesDiv = document.getElementById('chatMessages');
            chatMessagesDiv.innerHTML = '';
            
            room.chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.type}`;
                
                if (msg.type === 'system') {
                    messageDiv.innerHTML = `💬 ${msg.message}`;
                } else {
                    const isOwnMessage = msg.player === gameData.playerName;
                    messageDiv.className = `chat-message ${isOwnMessage ? 'player' : 'opponent'}`;
                    messageDiv.innerHTML = `<strong>${msg.player}:</strong> ${msg.message}`;
                }
                
                chatMessagesDiv.appendChild(messageDiv);
            });
            
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        // UPDATE ROOM DISPLAY - Real-time dari Supabase
        function updateRoomDisplay(room) {
            if (!room) {
                showError('Room tidak ditemukan!');
                leaveRoom();
                return;
            }
            
            console.log('Updating room display:', room);
            
            document.getElementById('displayRoomCode').innerHTML = `ROOM-${gameData.roomCode}<br><button class="copy-btn" onclick="copyRoomCode()">📋 Copy Kode Room</button>`;
            document.getElementById('roomTaruhan').textContent = `Rp ${formatRupiah(room.taruhan)}`;
            document.getElementById('roomMode').textContent = getModeDisplayName(room.gameMode || 'single');
            
            updateChatDisplay(room);
            
            // Update score display untuk multi-round modes
            if (room.gameMode !== 'single') {
                document.getElementById('scoreDisplay').style.display = 'block';
                document.getElementById('scoreValue').textContent = `${room.scores.player1 || 0} - ${room.scores.player2 || 0}`;
                document.getElementById('roundInfo').textContent = `Ronde ${room.currentRound || 1}`;
            } else {
                document.getElementById('scoreDisplay').style.display = 'none';
            }
            
            // Update room status
            if (room.status === 'finished') {
                document.getElementById('roomStatus').textContent = 'Permainan selesai!';
                // Trigger cleanup untuk room yang sudah selesai
                cleanupFinishedRoom(gameData.roomCode);
            } else if (room.player1.confirmed && room.player2 && room.player2.confirmed) {
                document.getElementById('roomStatus').textContent = 'Kedua player READY!';
                // Hitung hasil jika kedua pemain sudah konfirmasi
                setTimeout(() => calculateResult(room), 1000);
            } else {
                document.getElementById('roomStatus').textContent = room.player2 ? 'Silakan pilih dan konfirmasi...' : 'Menunggu player...';
            }
            
            document.getElementById('playerCount').textContent = room.player2 ? '2/2' : '1/2';

            // Update player slots
            document.getElementById('player1Name').textContent = room.player1.name;
            
            if (room.player1.confirmed) {
                document.getElementById('player1Status').textContent = '✅ READY';
                document.getElementById('player1Slot').className = 'player confirmed';
            } else if (room.player1.pilihan) {
                document.getElementById('player1Status').textContent = 'Memilih...';
                document.getElementById('player1Slot').className = 'player choosed';
            } else {
                document.getElementById('player1Status').textContent = 'Belum memilih';
                document.getElementById('player1Slot').className = 'player';
            }

            if (room.player2) {
                document.getElementById('player2Name').textContent = room.player2.name;
                
                if (room.player2.confirmed) {
                    document.getElementById('player2Status').textContent = '✅ READY';
                    document.getElementById('player2Slot').className = 'player confirmed';
                } else if (room.player2.pilihan) {
                    document.getElementById('player2Status').textContent = 'Memilih...';
                    document.getElementById('player2Slot').className = 'player choosed';
                } else {
                    document.getElementById('player2Status').textContent = 'Belum memilih';
                    document.getElementById('player2Slot').className = 'player';
                }
            } else {
                document.getElementById('player2Name').textContent = '-';
                document.getElementById('player2Status').textContent = 'Menunggu...';
                document.getElementById('player2Slot').className = 'player';
            }

            // Show/hide choice sections based on game state
            const currentPlayer = room[`player${gameData.playerNumber}`];
            if (currentPlayer && !currentPlayer.confirmed && room.status !== 'finished') {
                document.getElementById('pilihanSection').style.display = 'block';
                document.getElementById('confirmationSection').style.display = 'none';
            } else {
                document.getElementById('pilihanSection').style.display = 'none';
                document.getElementById('confirmationSection').style.display = 'none';
            }

            // Show results if game finished
            if (room.status === 'finished' && room.hasil) {
                document.getElementById('hasilSection').style.display = 'block';
                updateResultDisplay(room);
            } else {
                document.getElementById('hasilSection').style.display = 'none';
            }
        }

        function selectChoice(pilihan) {
            gameData.tempChoice = pilihan;
            
            document.querySelectorAll('.btn-pilihan').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            document.getElementById('pilihanSection').style.display = 'none';
            document.getElementById('confirmationSection').style.display = 'block';
            document.getElementById('selectedChoice').textContent = pilihan.toUpperCase();
            
            playSound();
        }

        async function confirmChoice() {
            if (!gameData.tempChoice) {
                showError('Pilih pilihan dulu!');
                return;
            }

            const room = await getRoom(gameData.roomCode);
            if (!room) {
                showError('Room tidak ditemukan!');
                return;
            }

            const playerKey = `player${gameData.playerNumber}`;
            
            room[playerKey].pilihan = gameData.tempChoice;
            room[playerKey].confirmed = true;
            
            room.chatMessages.push({
                type: 'system',
                message: `✅ ${gameData.playerName} sudah memilih!`,
                timestamp: new Date().toISOString()
            });
            
            const success = await saveRoom(gameData.roomCode, room);
            
            if (success) {
                showSuccess('Pilihan dikonfirmasi! ✅');
                resetChoiceUI();
                playSound();
            } else {
                showError('Gagal menyimpan pilihan! Coba lagi.');
            }
        }

        function cancelChoice() {
            resetChoiceUI();
            showSuccess('Pilihan dibatalkan');
            playSound();
        }

        async function calculateResult(roomData) {
            let room = roomData;
            if (!room) {
                room = await getRoom(gameData.roomCode);
            }
            
            if (!room || !room.player1 || !room.player2) return;
            
            const p1 = room.player1.pilihan;
            const p2 = room.player2.pilihan;
            
            if (!p1 || !p2) return;
            
            let roundWinner = null;
            let roundMessage = '';

            if (p1 === p2) {
                roundWinner = 'seri';
                roundMessage = `Ronde ${room.currentRound} SERI!`;
            } else if (
                (p1 === 'batu' && p2 === 'gunting') ||
                (p1 === 'gunting' && p2 === 'kertas') ||
                (p1 === 'kertas' && p2 === 'batu')
            ) {
                roundWinner = 1;
                roundMessage = `${room.player1.name} menang Ronde ${room.currentRound}!`;
                room.scores.player1 = (room.scores.player1 || 0) + 1;
            } else {
                roundWinner = 2;
                roundMessage = `${room.player2.name} menang Ronde ${room.currentRound}!`;
                room.scores.player2 = (room.scores.player2 || 0) + 1;
            }

            // Simpan history ronde
            room.roundHistory.push({
                round: room.currentRound,
                p1Choice: p1,
                p2Choice: p2,
                winner: roundWinner
            });

            // Cek apakah game sudah selesai berdasarkan mode
            let gameFinished = false;
            let finalWinner = null;
            let finalMessage = '';

            if (room.gameMode === 'single') {
                gameFinished = true;
                finalWinner = roundWinner;
                finalMessage = roundWinner === 'seri' ? 'SERI!' : 
                             roundWinner === 1 ? `${room.player1.name} MENANG! 🎉` : 
                             `${room.player2.name} MENANG! 🎉`;
            } 
            else if (room.gameMode === 'bo3') {
                if (room.scores.player1 >= 2) {
                    gameFinished = true;
                    finalWinner = 1;
                    finalMessage = `${room.player1.name} MENANG Best of 3! 🏆`;
                } else if (room.scores.player2 >= 2) {
                    gameFinished = true;
                    finalWinner = 2;
                    finalMessage = `${room.player2.name} MENANG Best of 3! 🏆`;
                } else if (room.currentRound >= 3 && room.scores.player1 === room.scores.player2) {
                    gameFinished = true;
                    finalWinner = 'seri';
                    finalMessage = 'SERI Best of 3!';
                }
            }

            if (gameFinished) {
                let totalPot = room.taruhan * 2;
                let feeAdmin = calculateAdminFee(room.taruhan);
                let hadiahBersih = totalPot - feeAdmin;

                room.hasil = { 
                    pemenang: finalWinner, 
                    hasil: finalMessage,
                    p1Choice: p1,
                    p2Choice: p2,
                    totalPot: totalPot,
                    feeAdmin: feeAdmin,
                    hadiahBersih: hadiahBersih,
                    scores: room.scores,
                    roundHistory: room.roundHistory
                };
                room.status = 'finished';
                
                room.chatMessages.push({
                    type: 'system',
                    message: `🏆 ${finalMessage}`,
                    timestamp: new Date().toISOString()
                });
            } else {
                // Lanjut ke ronde berikutnya
                room.currentRound++;
                room.player1.pilihan = null;
                room.player1.confirmed = false;
                room.player2.pilihan = null;
                room.player2.confirmed = false;
                
                room.chatMessages.push({
                    type: 'system',
                    message: `🔄 ${roundMessage} Menuju Ronde ${room.currentRound}!`,
                    timestamp: new Date().toISOString()
                });
            }
            
            await saveRoom(gameData.roomCode, room);
            playSound();
        }

        function updateResultDisplay(room) {
            if (!room.hasil) return;

            const hasil = room.hasil;
            
            let historyHTML = '';
            if (room.roundHistory && room.roundHistory.length > 0) {
                historyHTML = '<div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">';
                historyHTML += '<strong>Riwayat Ronde:</strong><br>';
                room.roundHistory.forEach(round => {
                    let roundResult = '';
                    if (round.winner === 'seri') {
                        roundResult = 'SERI';
                    } else if (round.winner === 1) {
                        roundResult = `${room.player1.name} Menang`;
                    } else {
                        roundResult = `${room.player2.name} Menang`;
                    }
                    historyHTML += `Ronde ${round.round}: ${round.p1Choice} vs ${round.p2Choice} → ${roundResult}<br>`;
                });
                historyHTML += `</div><p><strong>Final Score: ${room.scores.player1} - ${room.scores.player2}</strong></p>`;
            }
            
            document.getElementById('hasilPertandingan').innerHTML = `
                ${historyHTML}
                <p>${room.player1.name}: <strong>${hasil.p1Choice ? hasil.p1Choice.toUpperCase() : 'BELUM MEMILIH'}</strong></p>
                <p>${room.player2.name}: <strong>${hasil.p2Choice ? hasil.p2Choice.toUpperCase() : 'BELUM MEMILIH'}</strong></p>
            `;

            const statusElement = document.getElementById('statusPemenang');
            statusElement.textContent = hasil.hasil;
            statusElement.className = hasil.pemenang === 'seri' ? 'seri' : 'menang';

            let pembayaranHTML = '';
            if (hasil.pemenang === 'seri') {
                pembayaranHTML = `
                    <p>💰 Total Taruhan: Rp ${formatRupiah(hasil.totalPot)}</p>
                    <p>🏦 Fee Admin: Rp ${formatRupiah(hasil.feeAdmin)}</p>
                    <p>🔙 Dana dikembalikan ke masing-masing player</p>
                `;
            } else {
                const pemenangName = hasil.pemenang === 1 ? room.player1.name : room.player2.name;
                pembayaranHTML = `
                    <p>💰 Total Pot: Rp ${formatRupiah(hasil.totalPot)}</p>
                    <p>🏦 Fee Admin: Rp ${formatRupiah(hasil.feeAdmin)}</p>
                    <p>🎁 Hadiah Bersih: Rp ${formatRupiah(hasil.hadiahBersih)}</p>
                    <p>👑 ${pemenangName} mendapatkan: Rp ${formatRupiah(hasil.hadiahBersih)}</p>
                `;
            }
            
            document.getElementById('pembayaranInfo').innerHTML = pembayaranHTML;
            document.getElementById('hasilSection').style.display = 'block';
        }

        async function rematch() {
            const room = await getRoom(gameData.roomCode);
            room.player1.pilihan = null;
            room.player1.confirmed = false;
            room.player2.pilihan = null;
            room.player2.confirmed = false;
            room.status = 'ready';
            room.hasil = null;
            room.showChoices = false;
            room.scores = { player1: 0, player2: 0 };
            room.currentRound = 1;
            room.roundHistory = [];
            
            room.chatMessages.push({
                type: 'system',
                message: '🔄 Memulai permainan baru!',
                timestamp: new Date().toISOString()
            });
            
            document.getElementById('hasilSection').style.display = 'none';
            await saveRoom(gameData.roomCode, room);
            resetChoiceUI();
            playSound();
        }

        async function leaveRoom() {
            stopRoomListener();
            
            const room = await getRoom(gameData.roomCode);
            if (room) {
                room.chatMessages.push({
                    type: 'system',
                    message: `🚪 ${gameData.playerName} meninggalkan room`,
                    timestamp: new Date().toISOString()
                });
                
                if (gameData.isCreator) {
                    await deleteRoom(gameData.roomCode);
                } else {
                    room.player2 = null;
                    room.status = 'waiting';
                    room.showChoices = false;
                    await saveRoom(gameData.roomCode, room);
                }
            }
            
            showSection('sectionLobby');
            updateRoomStats();
            playSound();
        }

        function formatRupiah(angka) {
            return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // Test koneksi Supabase
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('rooms')
                    .select('count')
                    .limit(1);
                
                const statusElement = document.getElementById('connectionStatus');
                const detailsElement = document.getElementById('connectionDetails');
                
                if (error) {
                    statusElement.textContent = '❌ Gagal';
                    detailsElement.textContent = `Error: ${error.message}`;
                    updateDebugInfo(`Koneksi gagal: ${error.message}`);
                    
                    // Cek apakah tabel 'rooms' ada
                    if (error.message.includes('does not exist')) {
                        showError('Tabel "rooms" belum dibuat di Supabase. Silakan buat tabel terlebih dahulu.');
                    }
                } else {
                    statusElement.textContent = '✅ Terhubung';
                    detailsElement.textContent = '';
                    updateDebugInfo('Koneksi Supabase berhasil');
                }
            } catch (error) {
                console.error('Connection test error:', error);
                updateDebugInfo(`Test koneksi error: ${error.message}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default player name
            document.getElementById('playerName').value = gameData.playerName;
            updateRoomStats();
            
            // Test koneksi Supabase
            testSupabaseConnection();
            
            // Start auto-cleanup (setiap 6 jam)
            setInterval(cleanupOldRooms, 6 * 60 * 60 * 1000);
            
            // Run cleanup sekali saat start
            setTimeout(cleanupOldRooms, 5000);
            
            console.log('Game initialized with Supabase + Auto-Cleanup + Best of 3');
        });
    </script>
</body>
</html>